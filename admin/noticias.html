<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Cargar Noticias</title>
    <link rel="icon" type="image/x-icon" href="../imagenes/favicon.ico">
  <link rel="stylesheet" href="style.css">
    <!-- Early dark mode to prevent flash -->
    <script>
        (function () {
            if (localStorage.getItem('iasa_dark_mode') === 'true') {
                document.documentElement.classList.add('dark-mode');
                if (document.body) document.body.classList.add('dark-mode');
                else document.addEventListener('DOMContentLoaded', function () {
                    document.body.classList.add('dark-mode');
                });
            }
        })();
    </script>
</head>

<body>
    <a href="/homenoticias" class="back-link"
        style="position:fixed;left:8px;top:8px;z-index:999;color:rgba(0,0,0,0.65);font-size:18px;text-decoration:none;padding:6px">‚Üê</a>
    <div class="container">
        <a href="/homenoticias" class="back-btn">‚Üê Volver al inicio</a>

        <div class="user-badge" id="userBadge">
            <span class="dot"></span>
            <span id="userEmail">Cargando...</span>
        </div>

        <div class="header">
            <h1>üì∞ Cargar Noticia</h1>
            <p>Publica novedades con im√°genes o videos</p>
        </div>

        <!-- Formulario de carga -->
        <div class="card">
            <div class="card-title">
                <span>‚ú®</span> Nueva publicaci√≥n
            </div>

            <form id="newsForm">
                <div class="form-group">
                    <label for="title">T√≠tulo *</label>
                    <input type="text" id="title" placeholder="Ej: D√≠a de Campo IASA 2026" required>
                </div>

                <div class="form-group">
                    <label for="description">Descripci√≥n *</label>
                    <textarea id="description" placeholder="Escribe una descripci√≥n breve de la noticia..."
                        required></textarea>
                </div>

                <div class="form-group">
                    <label for="url">Enlace (opcional)</label>
                    <input type="url" id="url" placeholder="https://ejemplo.com/noticia">
                </div>

                <label style="display:block; font-size:14px; font-weight:500; color:#555; margin-bottom:12px;">Tipo de
                    contenido *</label>

                <div class="media-type-selector">
                    <button type="button" class="media-type-btn active" data-type="image">
                        <div class="icon">üñºÔ∏è</div>
                        <div class="label">Imagen</div>
                    </button>
                    <button type="button" class="media-type-btn" data-type="video">
                        <div class="icon">üé¨</div>
                        <div class="label">Video</div>
                    </button>
                </div>

                <!-- Upload de archivo -->
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon" id="uploadIcon">üñºÔ∏è</div>
                    <div class="upload-text">
                        <strong>Click para subir</strong> o arrastra aqu√≠<br>
                        <span id="uploadHint">PNG, JPG hasta 5MB</span>
                    </div>
                    <input type="file" id="fileInput" accept="image/*">
                </div>

                <div class="preview-container" id="previewContainer">
                    <img id="previewImage" src="" alt="Preview">
                    <video id="previewVideo" src="" controls style="display:none;"></video>
                    <button type="button" class="preview-remove" id="removePreview">‚úï</button>
                </div>

                <div class="url-toggle">
                    ‚Äî o ‚Äî
                    <a id="toggleUrlInput">usar URL directa</a>
                </div>

                <div class="url-input-section" id="urlInputSection">
                    <div class="form-group">
                        <label for="mediaUrl" id="mediaUrlLabel">URL de la imagen</label>
                        <input type="url" id="mediaUrl" placeholder="https://ejemplo.com/imagen.jpg">
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    <span class="spinner"></span>
                    <span class="btn-text">üì§ Publicar noticia</span>
                </button>
            </form>
        </div>

        <!-- Lista de noticias existentes -->
        <div class="card news-list-card">
            <div class="card-title">
                <span>üìã</span> Noticias publicadas
            </div>
            <div class="news-limit-info">
                <span class="info-icon">‚ÑπÔ∏è</span>
                <span>Solo se muestran <strong>3 noticias</strong> en la app. Usa las flechas para cambiar el
                    orden.</span>
            </div>
            <div id="newsList">
                <div class="empty-state">
                    <div class="icon">‚è≥</div>
                    <p>Cargando noticias...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script type="module">
        import { app, auth, db } from '/firebase.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
        import {
            collection, addDoc, query, orderBy, limit, onSnapshot, deleteDoc, doc, serverTimestamp, updateDoc, getDocs, writeBatch
        } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
        import {
            getStorage, ref, uploadBytes, getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

        const storage = getStorage(app);

        /**
         * Comprime una imagen File/Blob y devuelve un Blob comprimido
         * @param {File} file - Archivo de imagen a comprimir
         * @param {number} maxWidth - Ancho m√°ximo en p√≠xeles (default: 1920)
         * @param {number} quality - Calidad JPEG 0-1 (default: 0.85)
         * @returns {Promise<Blob>} - Blob de imagen comprimida
         */
        function compressImageFile(file, maxWidth = 1920, quality = 0.85) {
            return new Promise((resolve, reject) => {
                // Si no es imagen, devolver el archivo original
                if (!file.type.startsWith('image/')) {
                    resolve(file);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        let w = img.width, h = img.height;

                        // Solo redimensionar si excede el ancho m√°ximo
                        if (w > maxWidth) {
                            const ratio = maxWidth / w;
                            w = Math.round(w * ratio);
                            h = Math.round(h * ratio);
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);

                        canvas.toBlob((blob) => {
                            if (blob) {
                                console.log(`[Compresi√≥n] ${(file.size / 1024).toFixed(0)}KB ‚Üí ${(blob.size / 1024).toFixed(0)}KB (${Math.round((1 - blob.size / file.size) * 100)}% reducido)`);
                                resolve(blob);
                            } else {
                                reject(new Error('Error al comprimir imagen'));
                            }
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = () => reject(new Error('Error al cargar imagen'));
                    img.src = e.target.result;
                };
                reader.onerror = () => reject(new Error('Error al leer archivo'));
                reader.readAsDataURL(file);
            });
        }

        // Emails con acceso de administrador
        const ADMIN_EMAILS = [
            'juanv27072017@gmail.com'
        ];

        // Verificar autenticaci√≥n y permisos
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.replace('/');
                return;
            }

            // Mostrar email del usuario
            document.getElementById('userEmail').textContent = user.email;

            // Verificar si es admin
            if (!ADMIN_EMAILS.includes(user.email)) {
                document.querySelector('.container').innerHTML = `
                    <a href="/homenoticias" class="back-btn">‚Üê Volver al inicio</a>
                    <div class="card">
                        <div class="access-denied">
                            <div class="icon">üîí</div>
                            <h2>Acceso Restringido</h2>
                            <p>No tienes permisos para acceder a esta secci√≥n.<br>
                            Usuario actual: <strong>${user.email}</strong></p>
                            <a href="/homenoticias" class="btn">Volver al inicio</a>
                        </div>
                    </div>
                `;
                return;
            }

            console.log('Admin autenticado:', user.email);
            loadNews();
        });

        // Variables
        let currentMediaType = 'image';
        let selectedFile = null;
        let useUrlInput = false;

        // Elementos del DOM
        const form = document.getElementById('newsForm');
        const mediaTypeBtns = document.querySelectorAll('.media-type-btn');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const previewImage = document.getElementById('previewImage');
        const previewVideo = document.getElementById('previewVideo');
        const removePreviewBtn = document.getElementById('removePreview');
        const toggleUrlBtn = document.getElementById('toggleUrlInput');
        const urlInputSection = document.getElementById('urlInputSection');
        const mediaUrlInput = document.getElementById('mediaUrl');
        const mediaUrlLabel = document.getElementById('mediaUrlLabel');
        const uploadIcon = document.getElementById('uploadIcon');
        const uploadHint = document.getElementById('uploadHint');
        const submitBtn = document.getElementById('submitBtn');

        // Cambiar tipo de media
        mediaTypeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                mediaTypeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMediaType = btn.dataset.type;
                updateUploadUI();
                clearPreview();
            });
        });

        function updateUploadUI() {
            if (currentMediaType === 'image') {
                uploadIcon.textContent = 'üñºÔ∏è';
                uploadHint.textContent = 'PNG, JPG hasta 5MB';
                fileInput.accept = 'image/*';
                mediaUrlLabel.textContent = 'URL de la imagen';
                mediaUrlInput.placeholder = 'https://ejemplo.com/imagen.jpg';
            } else {
                uploadIcon.textContent = 'üé¨';
                uploadHint.textContent = 'MP4, WebM hasta 50MB o URL de YouTube';
                fileInput.accept = 'video/*';
                mediaUrlLabel.textContent = 'URL del video (YouTube, MP4, etc.)';
                mediaUrlInput.placeholder = 'https://youtube.com/watch?v=... o video.mp4';
            }
        }

        // Drag & Drop
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFileSelect(file);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleFileSelect(e.target.files[0]);
        });

        async function handleFileSelect(file) {
            // Validar tama√±o inicial (antes de comprimir)
            const maxSize = currentMediaType === 'image' ? 10 * 1024 * 1024 : 50 * 1024 * 1024; // 10MB para im√°genes (se comprimir√°n)
            if (file.size > maxSize) {
                showToast(`El archivo es muy grande. M√°ximo ${currentMediaType === 'image' ? '10MB' : '50MB'}`, 'error');
                return;
            }

            mediaUrlInput.value = ''; // Limpiar URL si se sube archivo

            // Comprimir si es imagen
            if (currentMediaType === 'image' && file.type.startsWith('image/')) {
                try {
                    showToast('Comprimiendo imagen...', 'info');
                    const compressedBlob = await compressImageFile(file, 1920, 0.85);
                    selectedFile = new File([compressedBlob], file.name.replace(/\.[^.]+$/, '.jpg'), { type: 'image/jpeg' });
                    showToast(`Imagen comprimida: ${(selectedFile.size / 1024).toFixed(0)}KB`, 'success');
                } catch (err) {
                    console.error('Error comprimiendo:', err);
                    selectedFile = file; // Usar original si falla
                }
            } else {
                selectedFile = file;
            }

            // Mostrar preview
            const reader = new FileReader();
            reader.onload = (e) => {
                if (currentMediaType === 'image') {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                    previewVideo.style.display = 'none';
                } else {
                    previewVideo.src = e.target.result;
                    previewVideo.style.display = 'block';
                    previewImage.style.display = 'none';
                }
                previewContainer.classList.add('show');
                uploadArea.style.display = 'none';
            };
            reader.readAsDataURL(selectedFile);
        }

        // Remover preview
        removePreviewBtn.addEventListener('click', clearPreview);

        function clearPreview() {
            selectedFile = null;
            previewImage.src = '';
            previewVideo.src = '';
            previewContainer.classList.remove('show');
            uploadArea.style.display = 'block';
            fileInput.value = '';
        }

        // Toggle URL input
        toggleUrlBtn.addEventListener('click', () => {
            useUrlInput = !useUrlInput;
            urlInputSection.classList.toggle('show', useUrlInput);
            toggleUrlBtn.textContent = useUrlInput ? 'subir archivo' : 'usar URL directa';
        });

        // Enviar formulario
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const url = document.getElementById('url').value.trim();
            const mediaUrl = mediaUrlInput.value.trim();

            if (!title || !description) {
                showToast('Completa el t√≠tulo y descripci√≥n', 'error');
                return;
            }

            if (!selectedFile && !mediaUrl) {
                showToast(`Sube ${currentMediaType === 'image' ? 'una imagen' : 'un video'} o ingresa una URL`, 'error');
                return;
            }

            submitBtn.classList.add('loading');
            submitBtn.disabled = true;

            try {
                let finalMediaUrl = mediaUrl;

                // Subir archivo si se seleccion√≥
                if (selectedFile) {
                    const fileName = `news_${Date.now()}_${selectedFile.name}`;
                    const storageRef = ref(storage, `news_uploads/${fileName}`);
                    await uploadBytes(storageRef, selectedFile);
                    finalMediaUrl = await getDownloadURL(storageRef);
                }

                // Crear documento en Firestore
                // Obtener el orden m√≠nimo actual para poner la nueva noticia al principio
                let minOrder = 0;
                if (allNewsData.length > 0) {
                    minOrder = Math.min(...allNewsData.map(n => n.order ?? 0)) - 1;
                }

                const newsData = {
                    title,
                    description,
                    url: url || '',
                    createdAt: serverTimestamp(),
                    order: minOrder // Nueva noticia va primero
                };

                // Asignar al campo correcto seg√∫n tipo
                if (currentMediaType === 'image') {
                    newsData.image = finalMediaUrl;
                } else {
                    newsData.video = finalMediaUrl;
                }

                await addDoc(collection(db, 'news_uploads'), newsData);

                showToast('¬°Noticia publicada exitosamente!', 'success');
                form.reset();
                clearPreview();
                mediaUrlInput.value = '';

            } catch (error) {
                console.error('Error:', error);
                showToast('Error al publicar: ' + error.message, 'error');
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
            }
        });

        // Cargar noticias existentes
        let allNewsData = []; // Guardar todas las noticias para reordenar

        function loadNews() {
            // Ordenar primero por 'order' (ascendente), luego por fecha como fallback
            const q = query(collection(db, 'news_uploads'), orderBy('order', 'asc'), limit(20));

            onSnapshot(q, (snapshot) => {
                const newsList = document.getElementById('newsList');

                if (snapshot.empty) {
                    allNewsData = [];
                    newsList.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üì≠</div>
                            <p>No hay noticias publicadas</p>
                        </div>
                    `;
                    return;
                }

                // Guardar datos para reordenar
                allNewsData = snapshot.docs.map((docSnap, index) => ({
                    id: docSnap.id,
                    ...docSnap.data(),
                    currentOrder: docSnap.data().order ?? index
                }));

                // Ordenar por order, si no tiene order usar la fecha
                allNewsData.sort((a, b) => {
                    const orderA = a.order ?? 9999;
                    const orderB = b.order ?? 9999;
                    if (orderA !== orderB) return orderA - orderB;
                    // Fallback: ordenar por fecha descendente
                    return (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0);
                });

                newsList.innerHTML = allNewsData.map((data, index) => {
                    const id = data.id;
                    const hasVideo = data.video || data.videoUrl;
                    const mediaSrc = hasVideo ? (data.video || data.videoUrl) : (data.image || data.image_url || '');
                    const date = data.createdAt?.toDate?.() ? formatDate(data.createdAt.toDate()) : 'Reci√©n publicado';
                    const isVisible = index < 3; // Solo las primeras 3 son visibles en la app

                    // Para YouTube, usar thumbnail
                    let thumbnailSrc = mediaSrc;
                    if (hasVideo) {
                        const ytId = extractYouTubeId(mediaSrc);
                        if (ytId) {
                            thumbnailSrc = `https://img.youtube.com/vi/${ytId}/mqdefault.jpg`;
                        }
                    }

                    return `
                        <div class="news-item" style="${!isVisible ? 'opacity: 0.5; border: 1px dashed #ccc;' : ''}">
                            <div class="news-item-media">
                                ${hasVideo ? `
                                    <img src="${thumbnailSrc}" alt="" onerror="this.style.display='none'">
                                    <span class="video-badge">‚ñ∂ Video</span>
                                ` : `
                                    <img src="${mediaSrc}" alt="" onerror="this.style.display='none'">
                                `}
                            </div>
                            <div class="news-item-content">
                                <div class="news-item-title">
                                    ${isVisible ? `<span style="color:#28a745;margin-right:4px;">‚óè</span>` : `<span style="color:#999;margin-right:4px;">‚óã</span>`}
                                    ${escapeHtml(data.title || 'Sin t√≠tulo')}
                                </div>
                                <div class="news-item-desc">${escapeHtml(data.description || '')}</div>
                                <div class="news-item-date">${date} ${!isVisible ? '‚Ä¢ <em>Oculta en app</em>' : '‚Ä¢ <strong style="color:#28a745;">Visible</strong>'}</div>
                            </div>
                            <div class="news-item-actions">
                                <button class="news-item-move" onclick="window.moveNews('${id}', 'up')" title="Subir" ${index === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
                                <button class="news-item-move" onclick="window.moveNews('${id}', 'down')" title="Bajar" ${index === allNewsData.length - 1 ? 'disabled' : ''}>‚¨áÔ∏è</button>
                            </div>
                            <button class="news-item-delete" onclick="window.deleteNews('${id}')" title="Eliminar">üóëÔ∏è</button>
                        </div>
                    `;
                }).join('');

                // Asignar orden inicial a noticias que no lo tienen
                assignInitialOrder();
            }, (error) => {
                console.error('Error cargando noticias:', error);
                document.getElementById('newsList').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ö†Ô∏è</div>
                        <p>Error al cargar noticias</p>
                    </div>
                `;
            });
        }

        // Asignar orden inicial a noticias que no tienen el campo order
        async function assignInitialOrder() {
            const batch = writeBatch(db);
            let needsUpdate = false;

            allNewsData.forEach((newsItem, index) => {
                if (newsItem.order === undefined) {
                    batch.update(doc(db, 'news_uploads', newsItem.id), { order: index });
                    needsUpdate = true;
                }
            });

            if (needsUpdate) {
                try {
                    await batch.commit();
                    console.log('Orden inicial asignado a noticias');
                } catch (e) {
                    console.warn('Error asignando orden:', e);
                }
            }
        }

        // Funci√≥n para mover noticia
        window.moveNews = async (id, direction) => {
            const currentIndex = allNewsData.findIndex(n => n.id === id);
            if (currentIndex === -1) return;

            const targetIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            if (targetIndex < 0 || targetIndex >= allNewsData.length) return;

            try {
                // Intercambiar orders
                const currentItem = allNewsData[currentIndex];
                const targetItem = allNewsData[targetIndex];

                const currentOrder = currentItem.order ?? currentIndex;
                const targetOrder = targetItem.order ?? targetIndex;

                // Actualizar en Firestore
                const batch = writeBatch(db);
                batch.update(doc(db, 'news_uploads', currentItem.id), { order: targetOrder });
                batch.update(doc(db, 'news_uploads', targetItem.id), { order: currentOrder });
                await batch.commit();

                showToast('Orden actualizado', 'success');
            } catch (error) {
                console.error('Error moviendo noticia:', error);
                showToast('Error al reordenar: ' + error.message, 'error');
            }
        };

        // Funci√≥n para eliminar noticia
        window.deleteNews = async (id) => {
            if (!confirm('¬øEliminar esta noticia?')) return;

            try {
                await deleteDoc(doc(db, 'news_uploads', id));
                showToast('Noticia eliminada', 'success');
            } catch (error) {
                showToast('Error al eliminar: ' + error.message, 'error');
            }
        };

        // Utilidades
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function escapeHtml(str) {
            return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function formatDate(date) {
            return date.toLocaleDateString('es-ES', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function extractYouTubeId(url) {
            if (!url) return null;
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\s?]+)/,
                /^([a-zA-Z0-9_-]{11})$/
            ];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }
    </script>
</body>

</html>
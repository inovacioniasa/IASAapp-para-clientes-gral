rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===================================
    // üõ†Ô∏è FUNCIONES DE VALIDACI√ìN
    // ===================================
    function isAuth() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuth() && request.auth.token.email == 'juanv27072017@gmail.com';
    }

    function validString(text, min, max) {
      return text is string && text.size() >= min && text.size() <= max;
    }

    function validEmail(email) {
      // Validaci√≥n b√°sica de formato de correo
      return email is string && email.matches('^[^@]+@[^@]+\\.[^@]+$');
    }

    // =========================
    // üëë ADMIN - ACCESO TOTAL
    // =========================
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // =========================
    // USERS
    // =========================
    match /users/{userId} {
      allow create: if isOwner(userId);
      allow read, update, delete: if isOwner(userId);
    }

    match /users/{userId}/activities/{activityId} {
      allow read, write: if isOwner(userId);
    }

    // =========================
    // COMMUNITY
    // =========================
    match /community_posts/{postId} {
      allow read: if true;
      allow create: if isAuth() &&
        request.resource.data.authorId == request.auth.uid &&
        (
          validString(request.resource.data.message, 1, 1000) ||
          (request.resource.data.image is string && request.resource.data.image.size() > 0)
        );
      // Solo el autor puede borrar su post
      allow delete: if isOwner(resource.data.authorId);
    }

    // =========================
    // NEWS (Lectura p√∫blica, escritura protegida)
    // =========================
    match /news/{newsId} {
      allow read: if true;
      allow create, update, delete: if false; 
    }

    // =========================
    // NEWS UPLOADS
    // =========================
    match /news_uploads/{docId} {
      allow read: if true;
      allow create: if isAuth() && validString(request.resource.data.title, 2, 200);
      allow update: if isAdmin(); // Solo admin puede reordenar
      allow delete: if isAdmin(); 
    }

    // =========================
    // VISITAS & CONTACTOS (Lectura/Escritura controlada)
    // =========================
    
    match /visitas/{visitaId} {
      // Validar datos m√≠nimos para evitar spam de mensajes vac√≠os o gigantes
      allow create: if 
        validString(request.resource.data.name, 2, 100) &&
        validString(request.resource.data.farm, 2, 100) &&
        validString(request.resource.data.contact, 5, 100) &&
        validString(request.resource.data.message, 5, 2000);
      
      allow read, update, delete: if isAuth();
    }

    match /contactos/{contactoId} {
      allow create: if 
        validString(request.resource.data.name, 2, 100) &&
        validString(request.resource.data.location, 2, 100) &&
        validEmail(request.resource.data.email) &&
        validString(request.resource.data.message, 5, 2000);

      allow read, update, delete: if isAuth();
    }
    
    match /consultas/{docId} {
      allow create: if 
        validString(request.resource.data.name, 2, 100) &&
        validString(request.resource.data.email, 5, 100) &&
        validString(request.resource.data.message, 5, 2000);

      allow read, update, delete: if isAuth();
    }

    // =========================
    // ‚úÖ PRODUCTOS (Solo lectura p√∫blica)
    // =========================
    match /productos/{categoria}/items/{itemId} {
      allow read: if true;
      allow create, update, delete: if false;
    }

  }
}

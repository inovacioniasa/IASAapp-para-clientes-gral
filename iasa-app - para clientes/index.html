<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Anti-cache para iOS Chrome -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>IASA App - Iniciar sesión | Aplicación Agrícola</title>

    <!-- Force cache refresh para iOS (Safari + Chrome) - se ejecuta antes que cualquier otro recurso -->
    <script>
        (function () {
            window.deferredInstallPrompt = null;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                window.deferredInstallPrompt = e;
                console.log('[PWA] beforeinstallprompt recibido (Head)');
            });

            var APP_VERSION = '20260109c'; // CAMBIAR EN CADA DEPLOY
            var stored = localStorage.getItem('iasa_app_v');
            var sessionKey = 'iasa_sess_' + APP_VERSION;

            // Si la versión cambió, limpiar todo
            if (stored !== APP_VERSION) {
                console.log('[CacheBust] Nueva versión detectada:', APP_VERSION, '(anterior:', stored, ')');

                // Limpiar Cache API
                if ('caches' in window) {
                    caches.keys().then(function (names) {
                        console.log('[CacheBust] Eliminando caches:', names);
                        return Promise.all(names.map(function (name) { return caches.delete(name); }));
                    });
                }

                // Des-registrar todos los Service Workers
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(function (regs) {
                        console.log('[CacheBust] Des-registrando SWs:', regs.length);
                        regs.forEach(function (r) { r.unregister(); });
                    });
                }

                // Limpiar sessionStorage (Chrome iOS lo usa para cache)
                try { sessionStorage.clear(); } catch (e) { }

                localStorage.setItem('iasa_app_v', APP_VERSION);

                // Forzar recarga con cache-bust en URL (evita cache de Chrome iOS)
                if (stored) {
                    var url = window.location.href.split('?')[0].split('#')[0];
                    window.location.replace(url + '?_v=' + APP_VERSION + '&_t=' + Date.now());
                    return;
                }
            }

            // Limpiar el query string de cache-bust después de recargar
            if (window.location.search.indexOf('_v=') > -1 && !sessionStorage.getItem(sessionKey)) {
                sessionStorage.setItem(sessionKey, '1');
                history.replaceState(null, '', window.location.pathname);
            }
        })();
    </script>

    <meta name="description"
        content="IASA App - Aplicación para gestión de productos agrícolas, noticias del sector, cotizaciones y servicios para el campo. Ingresa a tu cuenta IASA.">
    <meta name="keywords"
        content="IASA, IASA App, IASAApp, aplicación IASA, productos agrícolas, herbicidas, insecticidas, fungicidas, fertilizantes, biológicos, agro, campo, cotizaciones agrícolas">
    <meta name="author" content="IASA">
    <meta name="robots" content="index, follow">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Seguridad -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <link rel="canonical" href="https://iasaapp.online/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://iasaapp.online/">
    <meta property="og:title" content="IASA App - Aplicación Agrícola">
    <meta property="og:description"
        content="Gestiona tus productos agrícolas, consulta cotizaciones y mantente informado con IASA App">
    <meta property="og:image" content="https://iasaapp.online/logo1.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://iasaapp.online/">
    <meta property="twitter:title" content="IASA App - Aplicación Agrícola">
    <meta property="twitter:description"
        content="Gestiona tus productos agrícolas, consulta cotizaciones y mantente informado con IASA App">

    <meta name="theme-color" content="#ffffff" />
    <link rel="manifest" href="manifest.json">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="imagenes/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="imagenes/favicon16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="imagenes/favicon32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="imagenes/apple.png">
    <link rel="icon" type="image/png" sizes="192x192" href="imagenes/android192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="imagenes/android512.png">

    <!-- Preload critical CSS -->
    <link rel="preload" href="styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="styles.css">
    </noscript>

    <!-- Critical CSS inline -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }


        body::before {
            content: "";
            position: fixed;
            inset: 2%;
            background: url('logo1.png') no-repeat center 40% / 90% auto;
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: "";
            position: fixed;
            inset: 2%;
            background: url('logo2.png') no-repeat center 75% / 95% auto;
            pointer-events: none;
            z-index: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(50px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 420px;
            position: relative;
            z-index: 1;
            overflow: hidden;
            animation: slideIn 0.5s ease-out, fadeBackground 2s forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Animación para que el fondo vaya perdiendo transparencia */
        @keyframes fadeBackground {
            from {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            to {
                background: rgba(255, 255, 255, 0.6);
                /* menos transparente */
                border: 1px solid rgba(255, 255, 255, 0.6);
            }
        }


        .login-content {
            padding: 50px 40px;
            text-align: center;
        }

        .welcome-text {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1a1a1a;
            letter-spacing: -0.5px;
        }

        .subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 40px;
            font-weight: 400;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
            position: relative;
        }

        .input-group label {
            display: block;
            font-size: 13px;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 13px 16px;
            border: 1.5px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            color: #1a1a1a;
        }

        .input-group input::placeholder {
            color: #999;
        }

        .input-group input:focus {
            outline: none;
            border-color: #1a1a1a;
            background: #fff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .login-button {
            width: 100%;
            padding: 14px;
            background: #1a1a1a;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 30px;
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
        }

        .login-button:hover {
            background: #2d2d2d;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .login-button:active {
            transform: translateY(0);
        }

        .forgot-password,
        .first-access {
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        .forgot-password a,
        .first-access a {
            color: #1a1a1a;
            text-decoration: none;
            display: inline-block;
            margin-top: 4px;
            font-weight: 600;
            position: relative;
            transition: all 0.3s ease;
        }

        .forgot-password a::after,
        .first-access a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 1.5px;
            bottom: -2px;
            left: 0;
            background-color: #1a1a1a;
            transition: width 0.3s ease;
        }

        .forgot-password a:hover::after,
        .first-access a:hover::after {
            width: 100%;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 28px 0;
            color: #999;
            font-size: 13px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e0e0e0;
        }

        .divider::before {
            margin-right: 12px;
        }

        .divider::after {
            margin-left: 12px;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2;
            padding: 20px;
        }

        .toast {
            position: fixed;
            left: 50%;
            bottom: 24px;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 3;
            font-size: 14px;
            display: none;
        }

        .toast.success {
            background: #2e7d32;
        }

        /* Estilos para el spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            /* Color del spinner */
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: none;
            /* Oculto por defecto */
            margin-left: 10px;
            /* Espacio entre el texto del botón y el spinner */
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .toast.error {
            background: #c62828;
        }

        .overlay.open {
            display: flex;
        }

        .modal {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
            width: 100%;
            max-width: 420px;
            padding: 24px;
        }

        .modal h3 {
            font-size: 20px;
            color: #1a1a1a;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .modal .sub {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 8px;
        }

        .btn {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1.5px solid #e0e0e0;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn.secondary {
            background: #fff;
            color: #1a1a1a;
        }

        .btn.primary {
            background: #1a1a1a;
            color: #fff;
            border-color: #1a1a1a;
        }

        /* Ocultar logo2 en vistas de escritorio */
        @media (min-width: 992px) {
            body::after {
                content: none;
            }
        }

        /* Estilos para el modal de instalación PWA */
        .install-modal {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 380px;
            padding: 32px 28px;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .install-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .install-modal-close:hover {
            background: #f0f0f0;
        }

        .install-modal-close svg {
            width: 18px;
            height: 18px;
            color: #666;
        }

        .install-modal-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            display: block;
            border-radius: 18px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .install-modal-title {
            font-size: 22px;
            font-weight: 700;
            color: #1a1a1a;
            text-align: center;
            margin-bottom: 10px;
        }

        .install-modal-subtitle {
            font-size: 14px;
            color: #666;
            text-align: center;
            line-height: 1.5;
            margin-bottom: 24px;
        }

        .install-modal-benefits {
            list-style: none;
            padding: 0;
            margin: 0 0 28px 0;
        }

        .install-modal-benefits li {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            font-size: 15px;
            color: #333;
        }

        .install-modal-benefits li svg {
            width: 22px;
            height: 22px;
            color: #22c55e;
            flex-shrink: 0;
        }

        .install-modal-btn {
            width: 100%;
            padding: 16px;
            background: #1e40af;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s ease;
        }

        .install-modal-btn:hover {
            background: #1e3a8a;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
        }

        .install-modal-btn svg {
            width: 20px;
            height: 20px;
        }

        .install-modal-skip {
            display: block;
            width: 100%;
            text-align: center;
            margin-top: 16px;
            font-size: 14px;
            color: #666;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            transition: color 0.2s;
        }

        .install-modal-skip:hover {
            color: #333;
        }

        /* Dark mode overrides */
        body.dark-mode {
            background: #121218 !important;
            color: #e4e4e7;
        }

        body.dark-mode::before {
            opacity: 0.3;
        }

        body.dark-mode::after {
            opacity: 0.3;
        }

        body.dark-mode .login-container {
            background: rgba(30, 30, 42, 0.85);
            border-color: rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        @keyframes fadeBackgroundDark {
            from {
                background: rgba(30, 30, 42, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.05);
            }

            to {
                background: rgba(30, 30, 42, 0.85);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
        }

        body.dark-mode .login-container {
            animation: slideIn 0.5s ease-out, fadeBackgroundDark 2s forwards;
        }

        body.dark-mode .welcome-text {
            color: #e4e4e7;
        }

        body.dark-mode .subtitle {
            color: #a1a1aa;
        }

        body.dark-mode .input-group label {
            color: #d4d4d8;
        }

        body.dark-mode .input-group input {
            background: rgba(22, 22, 30, 0.9);
            border-color: #2a2a36;
            color: #e4e4e7;
        }

        body.dark-mode .input-group input:focus {
            background: #1e1e2a;
            border-color: #8b7ff0;
        }

        body.dark-mode .forgot-password,
        body.dark-mode .first-access {
            color: #a1a1aa;
        }

        body.dark-mode .forgot-password a,
        body.dark-mode .first-access a {
            color: #e4e4e7;
        }

        body.dark-mode .forgot-password a::after,
        body.dark-mode .first-access a::after {
            background-color: #e4e4e7;
        }

        body.dark-mode .divider {
            color: #71717a;
        }

        body.dark-mode .divider::before,
        body.dark-mode .divider::after {
            background: #2a2a36;
        }

        body.dark-mode .overlay {
            background: rgba(0, 0, 0, 0.6);
        }

        body.dark-mode .modal {
            background: #1e1e2a;
        }

        body.dark-mode .modal h3 {
            color: #e4e4e7;
        }

        body.dark-mode .modal .sub {
            color: #a1a1aa;
        }

        body.dark-mode .btn.secondary {
            background: #2a2a36;
            color: #e4e4e7;
            border-color: #3a3a46;
        }

        body.dark-mode .install-modal {
            background: #1e1e2a;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        body.dark-mode .install-modal-title {
            color: #e4e4e7;
        }

        body.dark-mode .install-modal-subtitle {
            color: #a1a1aa;
        }

        body.dark-mode .install-modal-benefits li {
            color: #d4d4d8;
        }

        body.dark-mode .install-modal-close:hover {
            background: #2a2a36;
        }

        body.dark-mode .install-modal-skip {
            color: #a1a1aa;
        }

        body.dark-mode .install-modal-skip:hover {
            color: #e4e4e7;
        }
    </style>

    <!-- Early dark mode to prevent flash -->
    <script>
        (function () {
            if (localStorage.getItem('iasa_dark_mode') === 'true') {
                document.documentElement.classList.add('dark-mode');
                if (document.body) document.body.classList.add('dark-mode');
                else document.addEventListener('DOMContentLoaded', function () {
                    document.body.classList.add('dark-mode');
                });
            }
        })();
    </script>

    <!-- Async CSS loader fallback -->
    <script>
        !function (e) { "use strict"; var t = function (t, n, r) { var o, i = e.document, c = i.createElement("link"); if (n) o = n; else { var a = (i.body || i.getElementsByTagName("head")[0]).childNodes; o = a[a.length - 1] } var d = i.styleSheets; c.rel = "stylesheet", c.href = t, c.media = "only x", function e(t) { if (i.body) return t(); setTimeout(function () { e(t) }) }(function () { o.parentNode.insertBefore(c, n ? o : o.nextSibling) }); var f = function (e) { for (var t = c.href, n = d.length; n--;)if (d[n].href === t) return e(); setTimeout(function () { f(e) }) }; return c.addEventListener && c.addEventListener("load", r), c.onloadcssdefined = f, f(r), c }; "undefined" != typeof exports ? exports.loadCSS = t : e.loadCSS = t }("undefined" != typeof global ? global : this);
    </script>
</head>

<body>

    <!-- Debug: Error handler global para detectar problemas en Android -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            console.error('[Global Error]', msg, 'at', url, line, col, error);
            // Descomentar la siguiente línea para debug visual en Android
            // alert('Error: ' + msg + ' at line ' + line);
            return false;
        };
        window.addEventListener('unhandledrejection', function (event) {
            console.error('[Unhandled Promise Rejection]', event.reason);
        });
    </script>
    <div class="login-container">
        <div class="login-content">
            <h1 class="welcome-text">¡Bienvenido/a!</h1>
            <p class="subtitle">Ingresa tus credenciales para continuar</p>

            <form method="post" action="/" autocomplete="on">
                <div class="input-group">
                    <label for="email">Correo electrónico</label>
                    <input type="email" id="email" name="email" placeholder="tu@email.com" value="" autocomplete="email"
                        required>
                </div>

                <div class="input-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" name="password" placeholder="••••••••"
                        autocomplete="current-password" required>
                </div>

                <button type="submit" class="login-button" id="loginButton">
                    Iniciar sesión
                    <div class="spinner" id="loginSpinner"></div>
                </button>
            </form>

            <div class="forgot-password">
                ¿Olvidaste tu contraseña?
                <a id="recoverLink" href="#">Recuperar acceso</a>
            </div>

            <div class="divider">o</div>

            <div>
                <div class="first-access">
                    ¿Primera vez aquí?
                    <a href="/registro">Crear cuenta nueva</a>
                </div>
            </div>
        </div>
    </div>
    <div id="installOverlay" class="overlay" role="dialog" aria-modal="true">
        <div class="install-modal">
            <button id="installCancel" class="install-modal-close" aria-label="Cerrar">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <img src="imagenes/android192.png" alt="IASA App" class="install-modal-logo">
            <h3 class="install-modal-title">Instalar IASA App</h3>
            <p class="install-modal-subtitle">Instala la aplicación en tu dispositivo para un acceso más rápido y una
                mejor experiencia, incluso sin conexión.</p>
            <ul class="install-modal-benefits">
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Acceso rápido desde el inicio
                </li>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Navegación más fluida
                </li>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Experiencia de app nativa
                </li>
            </ul>
            <button id="installButton" class="install-modal-btn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Instalar ahora
            </button>
            <button id="installSkip" class="install-modal-skip">Ahora no</button>
        </div>
    </div>
    <div id="recoverOverlay" class="overlay" role="dialog" aria-modal="true">
        <div class="modal">
            <h3>Recuperar acceso</h3>
            <p class="sub">Ingresa tu correo para recibir las instrucciones. Si no ves el email en unos minutos, revisa
                tu carpeta de correo no deseado o de promociones/spam.</p>
            <div class="input-group">
                <label for="recoverEmail">Correo electrónico</label>
                <input type="email" id="recoverEmail" placeholder="tu@email.com">
            </div>
            <div class="modal-actions">
                <button id="recoverCancel" class="btn secondary">Cancelar</button>
                <button id="recoverSend" class="btn primary">Enviar</button>
            </div>
        </div>
    </div>
</body>
<script type="module">
    // Verificar soporte de ES modules y Firebase 
    console.log('[Index] Iniciando módulo de autenticación...');

    let auth, signInWithEmailAndPassword, sendPasswordResetEmail;

    try {
        const firebaseModule = await import('./firebase.js');
        auth = firebaseModule.auth;

        const authModule = await import("https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js");
        signInWithEmailAndPassword = authModule.signInWithEmailAndPassword;
        sendPasswordResetEmail = authModule.sendPasswordResetEmail;

        console.log('[Index] Módulos cargados correctamente');
    } catch (importError) {
        console.error('[Index] Error cargando módulos:', importError);
        alert('Error al cargar la aplicación. Por favor, recarga la página o verifica tu conexión.');
    }

    const form = document.querySelector('form');
    const loginButton = document.getElementById('loginButton');
    const loginSpinner = document.getElementById('loginSpinner');
    if (form && auth) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const email = emailInput ? emailInput.value.trim() : '';
            const password = passwordInput ? passwordInput.value : '';
            if (!email || !password) {
                showToast('Ingresa correo y contraseña', 'error');
                return;
            }

            loginButton.disabled = true;
            loginSpinner.style.display = 'inline-block';
            console.log('[Index] Intentando iniciar sesión...');

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log('[Index] Login exitoso:', userCredential.user.uid);
                // Usar replace para evitar problemas de navegación en Android
                window.location.replace('/homenoticias');
            } catch (err) {
                console.error('[Index] Error de autenticación:', err);
                // Mapear códigos de error de Firebase a mensajes amigables
                let msg = 'Error al iniciar sesión. Intenta nuevamente.';
                const code = err && err.code ? err.code : '';
                if (code === 'auth/wrong-password' || code === 'auth/invalid-credential') msg = 'Contraseña incorrecta.';
                else if (code === 'auth/user-not-found') msg = 'No existe una cuenta con ese correo.';
                else if (code === 'auth/invalid-email') msg = 'El correo ingresado no es válido.';
                else if (code === 'auth/too-many-requests') msg = 'Demasiados intentos. Intenta más tarde.';
                else if (code === 'auth/network-request-failed') msg = 'No se pudo verificar tus credenciales. Verifica tu conexión o la contraseña.';
                else if (err && err.message) {
                    // Evitar mostrar el mensaje crudo de Firebase en la UI; usar genérico y loggear detalle
                    const m = String(err.message || '');
                    if (/network/i.test(m)) msg = 'Error de red. Verifica tu conexión.';
                    else msg = 'Error al iniciar sesión. ' + (m.length > 0 ? m : '');
                    console.warn('[Index] Auth error:', code, err);
                } else if (err) {
                    console.warn('[Index] Auth error:', err);
                }
                showToast(msg, 'error');
            } finally {
                loginButton.disabled = false;
                loginSpinner.style.display = 'none';
            }
        });
    } else if (!auth) {
        console.error('[Index] Auth no está disponible - los módulos no cargaron correctamente');
    }
    const recoverLink = document.getElementById('recoverLink');
    const recoverOverlay = document.getElementById('recoverOverlay');
    const recoverCancel = document.getElementById('recoverCancel');
    const recoverSend = document.getElementById('recoverSend');
    let toastEl = null;
    function showToast(message, type = 'success') {
        if (!toastEl) {
            toastEl = document.createElement('div');
            toastEl.className = 'toast';
            document.body.appendChild(toastEl);
        }
        toastEl.textContent = message;
        toastEl.className = 'toast ' + type;
        toastEl.style.display = 'block';
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => { toastEl.style.display = 'none'; }, 4000);
    }
    if (recoverLink && recoverOverlay) {
        recoverLink.addEventListener('click', (e) => {
            e.preventDefault();
            recoverOverlay.classList.add('open'); // Mostrar el overlay
        });
    }
    if (recoverOverlay) {
        recoverOverlay.addEventListener('click', (e) => {
            if (e.target === recoverOverlay) recoverOverlay.classList.remove('open');
        });
    }
    if (recoverCancel) {
        recoverCancel.addEventListener('click', () => recoverOverlay.classList.remove('open'));
    }
    if (recoverSend) {
        recoverSend.addEventListener('click', async () => {
            const email = document.getElementById('recoverEmail');
            const value = email ? email.value.trim() : '';
            if (!value) {
                showToast('Ingresa tu correo electrónico', 'error');
                return;
            }
            try {
                await sendPasswordResetEmail(auth, value);
                showToast('Enviamos el correo de recuperación. Revisa tu bandeja y spam.', 'success');
                recoverOverlay.classList.remove('open');
            } catch (err) {
                const msg = err && err.code === 'auth/user-not-found' ? 'No existe una cuenta con ese correo.' : (err && err.message ? err.message : String(err));
                showToast('No se pudo enviar el correo: ' + msg, 'error');
            }
        });
    }

    // --- Lógica para mostrar aviso de instalación de PWA ---
    // guardamos el evento `beforeinstallprompt` para mostrar el prompt más tarde
    // guardamos el evento `beforeinstallprompt` para mostrar el prompt más tarde
    // let deferredInstallPrompt = null; // USAMOS window.deferredInstallPrompt (Global)
    const installOverlayEl = document.getElementById('installOverlay');
    const installButtonEl = document.getElementById('installButton');
    const installCancelEl = document.getElementById('installCancel');

    // Función para detectar entornos embebidos (WebView / APK) donde no queremos
    // mostrar el prompt de instalación de PWA.
    function isEmbeddedWebView() {
        const ua = navigator.userAgent || '';
        // 'wv' es habitual en Android WebView (ej: 'Version/4.0 Chrome/xx wv')
        if (/\bwv\b/i.test(ua)) return true;
        // Algunos WebView incluyen 'Version/X' junto a Android
        if (/Android.*Version\//i.test(ua)) return true;
        // Si la app nativa inyecta un objeto global (ej. Cordova/Android bridge)
        if (typeof window.Android !== 'undefined') return true;
        return false;
    }

    // Función para verificar si la app ya está instalada (modo standalone)
    function isAppInstalled() {
        return window.matchMedia('(display-mode: standalone)').matches ||
            window.navigator.standalone === true;
    }

    // Función para detectar iOS
    function isIOS() {
        return /iPhone|iPad|iPod/i.test(navigator.userAgent);
    }

    // Función para mostrar el modal de instalación y, si es posible, invocar el prompt nativo
    async function showInstallModalAndMaybePrompt() {
        if (!isAppInstalled() && !isEmbeddedWebView() && !isIOS() && installOverlayEl) {
            installOverlayEl.classList.add('open');
            // Ya no invocamos el prompt automáticamente.
            // La instalación se delega al botón "Instalar ahora".
        }
    }

    // Si el navegador dispara beforeinstallprompt, lo guardamos para usarlo después
    // (Movido al HEAD para captura temprana)
    // window.addEventListener('beforeinstallprompt', (e) => { ... });

    // Mostrar el modal al cargar la página, con retraso de 1s para intentar que el navegador ya haya creado el prompt
    const INSTALL_MODAL_DELAY_MS = 1000;
    function scheduleInstallModal() {
        setTimeout(() => {
            showInstallModalAndMaybePrompt();
        }, INSTALL_MODAL_DELAY_MS);
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        scheduleInstallModal();
    } else {
        document.addEventListener('DOMContentLoaded', () => {
            scheduleInstallModal();
        });
    }

    const installSkipEl = document.getElementById('installSkip');
    if (installCancelEl) installCancelEl.addEventListener('click', () => installOverlayEl.classList.remove('open'));
    if (installSkipEl) installSkipEl.addEventListener('click', () => installOverlayEl.classList.remove('open'));

    if (installButtonEl) installButtonEl.addEventListener('click', async () => {
        // Si ya tenemos el prompt, usarlo inmediatamente
        if (window.deferredInstallPrompt) {
            window.deferredInstallPrompt.prompt();
            try {
                const choice = await window.deferredInstallPrompt.userChoice;
                if (choice && choice.outcome === 'accepted') showToast('Gracias por instalar la app ✅', 'success');
                else showToast('Instalación cancelada', 'error');
            } catch (err) {
                showToast('No se pudo completar la instalación: ' + (err && err.message ? err.message : String(err)), 'error');
            }
            window.deferredInstallPrompt = null;
            installOverlayEl.classList.remove('open');
        } else {
            // Esperar un momento a que llegue el evento beforeinstallprompt
            showToast('Preparando instalación...', 'success');
            await new Promise(resolve => setTimeout(resolve, 1500));

            if (window.deferredInstallPrompt) {
                // El prompt llegó mientras esperábamos
                window.deferredInstallPrompt.prompt();
                try {
                    const choice = await window.deferredInstallPrompt.userChoice;
                    if (choice && choice.outcome === 'accepted') showToast('Gracias por instalar la app ✅', 'success');
                    else showToast('Instalación cancelada', 'error');
                } catch (err) {
                    showToast('No se pudo completar la instalación: ' + (err && err.message ? err.message : String(err)), 'error');
                }
                window.deferredInstallPrompt = null;
                installOverlayEl.classList.remove('open');
            } else {
                // Fallback con instrucciones específicas por plataforma
                const isAndroid = /Android/i.test(navigator.userAgent);
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

                if (isAndroid) {
                    showToast('Toca el menú ⋮ de Chrome y selecciona "Añadir a pantalla de inicio"', 'success');
                } else if (isIOS) {
                    showToast('Toca el botón Compartir y luego "Añadir a inicio"', 'success');
                } else {
                    showToast('Abre el menú del navegador y elige "Instalar app" o "Añadir a pantalla de inicio"', 'success');
                }
                installOverlayEl.classList.remove('open');
            }
        }
    });

    // Evento cuando la app se instala
    window.addEventListener('appinstalled', () => {
        deferredInstallPrompt = null;
        showToast('App instalada correctamente ✅', 'success');
        if (installOverlayEl) installOverlayEl.classList.remove('open');
    });
</script>
<script>
    // --- Registro del Service Worker para PWA ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
            // Detectar Android para forzar limpieza de caché si es necesario
            const isAndroid = /Android/i.test(navigator.userAgent);
            const cacheVersion = 'v2'; // Incrementar cuando haya cambios importantes
            const lastCacheVersion = localStorage.getItem('iasa_cache_version');

            // Si la versión del caché cambió o es Android con problemas, limpiar
            if (lastCacheVersion !== cacheVersion) {
                console.log('[Index] Nueva versión de caché detectada, limpiando...');
                try {
                    // Limpiar todos los cachés antiguos
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    console.log('[Index] Cachés antiguos eliminados');

                    // Desregistrar service workers antiguos y registrar el nuevo
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        await registration.unregister();
                        console.log('[Index] Service Worker desregistrado para actualización');
                    }

                    localStorage.setItem('iasa_cache_version', cacheVersion);

                    // Recargar para aplicar cambios limpios
                    if (isAndroid && registrations.length > 0) {
                        console.log('[Index] Recargando página para aplicar cambios...');
                        window.location.reload(true);
                        return;
                    }
                } catch (e) {
                    console.warn('[Index] Error limpiando caché:', e);
                }
            }

            // Usar ruta relativa para evitar 404 en entornos como GitHub Pages 
            const swScript = 'sw.js';
            console.log('[Index] Intentando registrar ServiceWorker desde:', swScript);
            navigator.serviceWorker.register(swScript)
                .then(registration => {
                    console.log('[Index] ServiceWorker registrado con éxito:', registration.scope);
                    // Forzar búsqueda de nueva versión
                    registration.update();

                    // Si ya hay un SW en estado waiting, pedirle que se active inmediatamente
                    if (registration.waiting) {
                        try {
                            console.log('[Index] SW en estado waiting - solicitando skipWaiting');
                            registration.waiting.postMessage('SKIP_WAITING');
                        } catch (e) { console.warn('[Index] No se pudo enviar mensaje a SW waiting', e); }
                    }

                    // Cuando aparezca una nueva instalación, pedir activación inmediata
                    registration.addEventListener('updatefound', () => {
                        const newSW = registration.installing;
                        if (!newSW) return;
                        newSW.addEventListener('statechange', () => {
                            if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                                try {
                                    console.log('[Index] Nueva versión instalada - solicitando skipWaiting');
                                    newSW.postMessage('SKIP_WAITING');
                                } catch (e) { console.warn('[Index] No se pudo pedir skipWaiting al nuevo SW', e); }
                            }
                        });
                    });

                    // Cuando el controller cambie (nuevo SW activado), recargar para usar la nueva versión
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        if (window.__swReloading) return;
                        window.__swReloading = true;
                        console.log('[Index] controllerchange detectado - recargando para aplicar nueva versión');
                        window.location.reload();
                    });
                })
                .catch(err => {
                    console.error('[Index] Fallo en el registro de ServiceWorker:', err);
                    console.info('Asegúrate de que "sw.js" esté publicado en la misma carpeta que "index.html" o en la raíz del sitio según el scope esperado.');
                });
        });
    }
</script>

</html>
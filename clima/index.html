<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Clima</title>
    <link rel="stylesheet" href="/styles.css?v=20260219a">
    <style>
        :root {
            --card-bg: #ffffff;
            --surface: #f5f6f7;
            --accent: #3c318f
        }

        body {
            background: var(--surface);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
            color: #111
        }

        .page-wrap {
            max-width: 420px;
            margin: 14px auto;
            padding: 12px
        }

        .back-link {
            display: inline-block;
            margin-bottom: 8px;
            color: var(--accent);
            text-decoration: none;
            font-weight: 700
        }

        h1 {
            margin: 6px 0 12px;
            font-size: 18px
        }

        .weather-forecast {
            display: block
        }

        .weather-day {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 14px;
            box-shadow: 0 8px 20px rgba(18, 18, 24, 0.06);
            border: 1px solid rgba(16, 24, 32, 0.04);
            margin-bottom: 12px
        }

        .weather-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .weather-day-info {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .weather-icon svg {
            width: 34px;
            height: 34px;
            color: var(--accent);
            display: block
        }

        .weather-day-name {
            font-weight: 700;
            font-size: 15px
        }

        .weather-temp {
            font-weight: 800;
            font-size: 16px;
            color: #111;
            text-align: right
        }

        .weather-temp .weather-temp-max {
            display: block
        }

        .weather-temp .weather-temp-min {
            display: block;
            color: #888;
            font-weight: 600;
            font-size: 13px
        }

        .weather-description {
            margin: 10px 0 12px;
            color: #555;
            font-size: 13px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0
        }

        .weather-details {
            display: flex;
            gap: 12px
        }

        .weather-detail-item {
            flex: 1
        }

        .weather-detail-label {
            font-size: 11px;
            color: #8a8a8a;
            text-transform: uppercase;
            letter-spacing: 0.6px
        }

        .weather-detail-value {
            font-weight: 700;
            margin-top: 6px;
            display: block;
            font-size: 14px
        }

        .weather-loading,
        .weather-error {
            padding: 18px;
            text-align: center;
            color: #666
        }

        .storage-images {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .storage-images img {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: block;
            object-fit: cover;
        }

        .storage-loading,
        .storage-error {
            text-align: center;
            padding: 15px;
            color: #555;
            font-size: 14px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(18, 18, 24, 0.06);
            border: 1px solid rgba(16, 24, 32, 0.04);
        }

        /* Loader overlay */
        .loader-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 12px;
            transition: opacity 200ms ease, visibility 200ms ease;
        }

        .loader-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loader-spinner {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 6px solid #eee;
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Carousel */
        .storage-carousel {
            position: relative;
            margin-bottom: 20px;
            background: transparent;
            overflow: visible;
        }

        .carousel-viewport {
            width: 100%;
            height: 220px;
            border-radius: 12px;
            overflow: hidden;
            background: #F5F6F7;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .carousel-viewport img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center center;
            display: block;
            position: absolute;
            inset: 0;
            opacity: 0;
            transition: opacity 300ms ease;
            background: transparent;
        }

        .carousel-viewport img.active { opacity: 1; position: relative; }

        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #000;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 2;
            -webkit-tap-highlight-color: transparent;
        }

        .carousel-btn.prev { left: 8px; }
        .carousel-btn.next { right: 8px; }

        .carousel-counter {
            text-align: center;
            margin-top: -10px;
            color: #000000;
            font-size: 13px;
            font-weight: 700;
        }

        @media (max-width:420px) {
            .page-wrap {
                padding: 10px
            }

            .weather-day {
                padding: 12px
            }
            .carousel-viewport {
                height: 320px;
            }
            .carousel-counter {
                margin-top: 8px;
            }
        }
    </style>
</head>

<body>
    <div class="page-wrap">
        <a href="/" class="back-link">← Volver</a>
        <h1>Clima</h1>

        <div id="storageCarouselContainer" class="storage-images">
            <div id="loaderOverlay" class="loader-overlay">
                <div class="loader-spinner" aria-hidden="true"></div>
                <div>Cargando mapas del clima…</div>
            </div>

            <div id="storageCarousel" class="storage-carousel">
                <button id="prevBtn" class="carousel-btn prev" aria-label="Anterior">‹</button>
                <div id="carouselViewport" class="carousel-viewport" role="region" aria-roledescription="carrusel"></div>
                <button id="nextBtn" class="carousel-btn next" aria-label="Siguiente">›</button>
            </div>
            <div id="carouselCounter" class="carousel-counter"></div>
        </div>

        <div class="weather-forecast" id="weatherForecast">
            <div class="weather-loading">Cargando pronóstico del tiempo...</div>
        </div>
    </div>

    <script src="/home.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (typeof loadWeatherForecast === 'function') {
                loadWeatherForecast();
            }
        });
    </script>
    <script type="module">
        import { storage, db } from "/firebase.js";
        import { ref, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";
        import { doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

        async function loadStorageImages() {
            const container = document.getElementById('storageCarouselContainer');
            const overlay = document.getElementById('loaderOverlay');
            const viewport = document.getElementById('carouselViewport');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const counter = document.getElementById('carouselCounter');

            if (!container || !viewport) return;

            try {
                overlay.classList.remove('hidden');

                const imagesRef = ref(storage, 'clima/fotos');
                const result = await listAll(imagesRef);
                const items = result.items.filter(item => item.name.match(/\.(jpg|jpeg|png|gif|webp)$/i));

                if (items.length === 0) {
                    container.innerHTML = '<div class="storage-loading">No hay mapas disponibles por el momento.</div>';
                    overlay.classList.add('hidden');
                    return;
                }

                const urls = await Promise.all(items.map(item => getDownloadURL(item)));
                const total = urls.length;

                async function fetchLabelFromFirestore(itemName) {
                    try {
                        // First try: match by exact storagePath (includes timestamp prefix)
                        const storagePath = `clima/fotos/${itemName}`;
                        const q1 = query(collection(db, 'clima_fotos'), where('storagePath', '==', storagePath));
                        const snap1 = await getDocs(q1);
                        if (!snap1.empty) {
                            const data = snap1.docs[0].data();
                            return data?.name || data?.caption || data?.filename || null;
                        }

                        // Fallback: try matching by filename (remove possible timestamp prefix)
                        const filename = String(itemName).replace(/^\d+_/, '');
                        const q2 = query(collection(db, 'clima_fotos'), where('filename', '==', filename));
                        const snap2 = await getDocs(q2);
                        if (!snap2.empty) {
                            const data = snap2.docs[0].data();
                            return data?.name || data?.caption || data?.filename || null;
                        }
                    } catch (e) {
                        console.error('fetchLabelFromFirestore error', e);
                    }
                    return null;
                }

                // build labels trying to read Firestore metadata first
                const labels = await Promise.all(items.map(async it => {
                    const fld = await fetchLabelFromFirestore(it.name);
                    return fld || it.name;
                }));

                function formatLabel(raw) {
                    let base = String(raw).replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ');
                    const iso = base.match(/(\d{4})[\.\- ]?(\d{2})[\.\- ]?(\d{2})/);
                    if (iso) {
                        try {
                            const dateStr = `${iso[1]}-${iso[2]}-${iso[3]}`;
                            const d = new Date(dateStr);
                            if (!isNaN(d)) {
                                const weekday = new Intl.DateTimeFormat('es', { weekday: 'long' }).format(d);
                                return weekday.charAt(0).toUpperCase() + weekday.slice(1);
                            }
                        } catch (e) { /* fallthrough */ }
                    }
                    return base.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                }
                const cache = {};
                let loadedCount = 0;
                let current = 0;

                const minToShow = Math.min(2, total);

                function filenameOnly(name) { return String(name).replace(/\.[^/.]+$/, ''); }

                function setCounter() {
                    const rawLabel = labels && labels[current] ? labels[current] : (items && items[current] && items[current].name ? filenameOnly(items[current].name) : `${current+1} / ${total}`);
                    counter.textContent = formatLabel(rawLabel);
                }

                function createImgFor(index) {
                    if (cache[index]) return cache[index];
                    const img = document.createElement('img');
                    img.dataset.index = index;
                    img.alt = formatLabel(labels && labels[index] ? labels[index] : `Mapa ${index+1}`);
                    img.src = urls[index];
                    img.loading = 'lazy';
                    img.addEventListener('load', () => {
                        loadedCount++;
                        if (!overlay.classList.contains('hidden') && (loadedCount >= minToShow || loadedCount === total)) {
                            overlay.classList.add('hidden');
                        }
                        setCounter();
                    });
                    img.addEventListener('error', () => { img.remove(); });
                    cache[index] = img;
                    return img;
                }

                function showSlide(index) {
                    if (index < 0) index = total-1;
                    if (index >= total) index = 0;
                    current = index;
                    const toKeep = [current, (current+1)%total];

                    Array.from(viewport.children).forEach(child => {
                        const idx = Number(child.dataset.index);
                        if (!toKeep.includes(idx)) viewport.removeChild(child);
                    });

                    toKeep.forEach(i => {
                        if (!viewport.querySelector(`img[data-index="${i}"]`)) {
                            const img = createImgFor(i);
                            viewport.appendChild(img);
                        }
                    });

                    Array.from(viewport.querySelectorAll('img')).forEach(img => {
                        img.classList.remove('active');
                        if (Number(img.dataset.index) === current) img.classList.add('active');
                    });
                    setCounter();
                }

                prevBtn.addEventListener('click', () => showSlide(current-1));
                nextBtn.addEventListener('click', () => showSlide(current+1));

                // touch support
                let startX = 0;
                viewport.addEventListener('touchstart', e => startX = e.touches[0].clientX);
                viewport.addEventListener('touchend', e => {
                    const dx = (e.changedTouches[0].clientX - startX);
                    if (Math.abs(dx) > 40) {
                        if (dx < 0) showSlide(current+1);
                        else showSlide(current-1);
                    }
                });

                // initial preload: current and next
                createImgFor(0);
                if (total > 1) createImgFor(1);
                showSlide(0);
            } catch (err) {
                console.error('Error al cargar imágenes de Storage:', err);
                container.innerHTML = '<div class="storage-error">Error al cargar los mapas. Verifique su conexión.</div>';
                document.getElementById('loaderOverlay').classList.add('hidden');
            }
        }

        loadStorageImages();
    </script>
</body>

</html>
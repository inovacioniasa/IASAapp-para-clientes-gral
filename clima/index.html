<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Clima</title>
    <link rel="stylesheet" href="/styles.css?v=20260219a">
    <style>
        :root {
            --card-bg: #ffffff;
            --surface: #f5f6f7;
            --accent: #3c318f;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            background: var(--surface);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #111;
            margin: 0;
        }

        /* ── Layout ── */
        .page-wrap {
            width: 100%;
            max-width: 540px;
            margin: 0 auto;
            padding: clamp(10px, 3vw, 28px);
        }

        .back-link {
            display: inline-block;
            margin-bottom: 8px;
            color: var(--accent);
            text-decoration: none;
            font-weight: 700;
            font-size: clamp(14px, 2.5vw, 16px);
        }

        h1 {
            margin: 6px 0 14px;
            font-size: clamp(20px, 4vw, 26px);
        }

        /* ── Carousel / Mapas ── */
        .storage-images {
            margin-bottom: 18px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .storage-images img {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: block;
            object-fit: cover;
        }

        .storage-loading,
        .storage-error {
            text-align: center;
            padding: 15px;
            color: #555;
            font-size: 14px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(18, 18, 24, 0.06);
            border: 1px solid rgba(16, 24, 32, 0.04);
        }

        .storage-carousel {
            position: relative;
            background: transparent;
            overflow: visible;
        }

        .carousel-viewport {
            width: 100%;
            /* Aspect-ratio based height for perfect responsiveness */
            aspect-ratio: 4/3;
            border-radius: 12px;
            overflow: hidden;
            background: #F5F6F7;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .carousel-viewport img {
            width: auto;
            max-width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center center;
            display: block;
            position: absolute;
            inset: 0;
            margin: auto;
            opacity: 0;
            transition: opacity 300ms ease;
            background: transparent;
        }

        .carousel-viewport img.active {
            opacity: 1;
            position: relative;
        }

        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.55);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: none;
            color: #000;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 2;
            -webkit-tap-highlight-color: transparent;
            transition: background 150ms ease;
        }

        .carousel-btn:hover,
        .carousel-btn:focus-visible {
            background: rgba(255,255,255,0.85);
        }

        .carousel-btn.prev { left: 6px; }
        .carousel-btn.next { right: 6px; }

        .carousel-counter {
            text-align: center;
            margin-top: 8px;
            color: #000;
            font-size: clamp(13px, 2.5vw, 15px);
            font-weight: 700;
        }

        /* ── Loader ── */
        .loader-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 12px;
            transition: opacity 200ms ease, visibility 200ms ease;
        }

        .loader-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loader-spinner {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 5px solid #eee;
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ── Weather Forecast ── */
        .weather-forecast {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .weather-day {
            background: var(--card-bg);
            border-radius: 14px;
            padding: clamp(12px, 3vw, 20px);
            box-shadow: 0 4px 16px rgba(18, 18, 24, 0.06);
            border: 1px solid rgba(16, 24, 32, 0.05);
        }

        .weather-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .weather-day-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .weather-icon svg {
            width: clamp(28px, 6vw, 38px);
            height: clamp(28px, 6vw, 38px);
            color: var(--accent);
            display: block;
        }

        .weather-day-name {
            font-weight: 700;
            font-size: clamp(14px, 3vw, 16px);
        }

        .weather-temp {
            font-weight: 800;
            font-size: clamp(18px, 4vw, 24px);
            color: #111;
            text-align: right;
            line-height: 1.25;
        }

        .weather-temp .weather-temp-max {
            display: block;
        }

        .weather-temp .weather-temp-min {
            display: block;
            color: #999;
            font-weight: 600;
            font-size: clamp(13px, 2.5vw, 15px);
        }

        .weather-description {
            margin: 10px 0 12px;
            color: #555;
            font-size: clamp(13px, 2.5vw, 14px);
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }

        .weather-details {
            display: flex;
            gap: 8px;
        }

        .weather-detail-item {
            flex: 1;
            min-width: 0;
        }

        .weather-detail-label {
            font-size: clamp(10px, 2vw, 11px);
            color: #8a8a8a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .weather-detail-value {
            font-weight: 700;
            margin-top: 5px;
            display: block;
            font-size: clamp(13px, 2.8vw, 15px);
        }

        .weather-loading,
        .weather-error {
            padding: 18px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        /* ── Responsive fine-tuning ── */

        /* Small phones */
        @media (max-width: 360px) {
            .carousel-btn { width: 30px; height: 30px; font-size: 16px; }
        }

        /* Tablets & small desktops: 2-column grid for forecast */
        @media (min-width: 700px) {
            .page-wrap {
                max-width: 720px;
                padding: 28px;
            }
            .weather-forecast {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 14px;
            }
            .carousel-viewport {
                aspect-ratio: 16/10;
            }
        }

        /* Large desktops */
        @media (min-width: 1100px) {
            .page-wrap {
                max-width: 960px;
                padding: 36px;
            }
            .weather-forecast {
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
            }
            h1 { font-size: 28px; }
        }
        /* Mobile: make the carousel/map occupy more vertical space and reduce gutters */
        @media (max-width: 700px) {
            .page-wrap { padding: 8px; max-width: 100%; }
            .storage-images { margin-bottom: 12px; }
            .carousel-viewport {
                /* Allow a taller viewport on phones (percentage of viewport height) */
                aspect-ratio: auto;
                height: min(56vh, 520px);
                border-radius: 12px;
            }
            .carousel-viewport img {
                position: absolute;
                inset: 0;
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .carousel-btn.prev { left: 6px; }
            .carousel-btn.next { right: 6px; }
        }
    </style>
</head>

<body>
    <div class="page-wrap">
        <a href="/" class="back-link">← Volver</a>
        <h1>Clima</h1>

        <div id="storageCarouselContainer" class="storage-images">
            <div id="loaderOverlay" class="loader-overlay">
                <div class="loader-spinner" aria-hidden="true"></div>
                <div>Cargando mapas del clima…</div>
            </div>

            <div id="storageCarousel" class="storage-carousel">
                <button id="prevBtn" class="carousel-btn prev" aria-label="Anterior">‹</button>
                <div id="carouselViewport" class="carousel-viewport" role="region" aria-roledescription="carrusel"></div>
                <button id="nextBtn" class="carousel-btn next" aria-label="Siguiente">›</button>
            </div>
            <div id="carouselCounter" class="carousel-counter"></div>
        </div>

        <div class="weather-forecast" id="weatherForecast">
            <div class="weather-loading">Cargando pronóstico del tiempo...</div>
        </div>
    </div>

    <script src="/home.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (typeof loadWeatherForecast === 'function') {
                loadWeatherForecast();
            }
        });
    </script>
    <script type="module">
        import { storage, db } from "/firebase.js";
        import { ref, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";
        import { doc, getDoc, collection, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";


        async function loadStorageImages() {
            const container = document.getElementById('storageCarouselContainer');
            const overlay = document.getElementById('loaderOverlay');
            const viewport = document.getElementById('carouselViewport');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const counter = document.getElementById('carouselCounter');

            if (!container || !viewport) return;

            const cacheKey = 'clima_images_cache_v1';

            function loadCache() {
                try {
                    const raw = localStorage.getItem(cacheKey);
                    return raw ? JSON.parse(raw) : null;
                } catch (e) { return null; }
            }

            function saveCache(obj) {
                try { localStorage.setItem(cacheKey, JSON.stringify(obj)); } catch (e) { /* ignore */ }
            }

            // Render from cached data immediately if available to speed up UI
            const cached = loadCache();
            if (cached && cached.urls && cached.urls.length) {
                try {
                    overlay.classList.add('hidden');
                    renderCarouselFromData(cached.urls, cached.labels || cached.names || []);
                } catch (e) { console.warn('cache render failed', e); }
            } else {
                overlay.classList.remove('hidden');
            }

            // Listen for Firestore changes to invalidate cache live
            try {
                const fotosCol = collection(db, 'clima_fotos');
                onSnapshot(fotosCol, snapshot => {
                    const serverNames = snapshot.docs.map(d => d.data().storagePath || d.data().filename || d.id).filter(Boolean);
                    const cachedNames = (cached && cached.names) ? cached.names : [];
                    const namesEqual = serverNames.length === cachedNames.length && serverNames.every((n, i) => n === cachedNames[i]);
                    if (!namesEqual) {
                        // Invalidate cache and reload from storage
                        localStorage.removeItem(cacheKey);
                        // fetch fresh
                        fetchFromStorageAndUpdate();
                    }
                }, err => {
                    console.warn('onSnapshot error', err);
                });
            } catch (e) { /* ignore if firestore not available */ }

            // main fetcher that lists storage and updates cache
            async function fetchFromStorageAndUpdate() {
                try {
                    overlay.classList.remove('hidden');
                    const imagesRef = ref(storage, 'clima/fotos');
                    const result = await listAll(imagesRef);
                    const items = result.items.filter(item => item.name.match(/\.(jpg|jpeg|png|gif|webp)$/i));

                    if (items.length === 0) {
                        container.innerHTML = '<div class="storage-loading">No hay mapas disponibles por el momento.</div>';
                        overlay.classList.add('hidden');
                        return;
                    }

                    const urls = await Promise.all(items.map(item => getDownloadURL(item)));

                    async function fetchLabelFromFirestore(itemName) {
                        try {
                            const storagePath = `clima/fotos/${itemName}`;
                            const q1 = query(collection(db, 'clima_fotos'), where('storagePath', '==', storagePath));
                            const snap1 = await getDocs(q1);
                            if (!snap1.empty) {
                                const data = snap1.docs[0].data();
                                return data?.name || data?.caption || data?.filename || null;
                            }
                            const filename = String(itemName).replace(/^\d+_/, '');
                            const q2 = query(collection(db, 'clima_fotos'), where('filename', '==', filename));
                            const snap2 = await getDocs(q2);
                            if (!snap2.empty) {
                                const data = snap2.docs[0].data();
                                return data?.name || data?.caption || data?.filename || null;
                            }
                        } catch (e) { console.error('fetchLabelFromFirestore error', e); }
                        return null;
                    }

                    const labels = await Promise.all(items.map(async it => {
                        const fld = await fetchLabelFromFirestore(it.name);
                        return fld || it.name;
                    }));

                    const names = items.map(i => i.name);
                    saveCache({ urls, labels, names, updatedAt: Date.now() });
                    renderCarouselFromData(urls, labels);
                } catch (err) {
                    console.error('Error al cargar imágenes de Storage:', err);
                    container.innerHTML = '<div class="storage-error">Error al cargar los mapas. Verifique su conexión.</div>';
                    overlay.classList.add('hidden');
                }
            }

            // helper that renders carousel given arrays
            function renderCarouselFromData(urls, labels) {
                // clear viewport
                viewport.innerHTML = '';
                const total = urls.length;
                const cacheEls = {};
                let loadedCount = 0;
                let current = 0;
                const minToShow = Math.min(2, total);

                function formatLabel(raw) {
                    let base = String(raw).replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ');
                    const iso = base.match(/(\d{4})[\.\- ]?(\d{2})[\.\- ]?(\d{2})/);
                    if (iso) {
                        try {
                            const dateStr = `${iso[1]}-${iso[2]}-${iso[3]}`;
                            const d = new Date(dateStr);
                            if (!isNaN(d)) {
                                const weekday = new Intl.DateTimeFormat('es', { weekday: 'long' }).format(d);
                                return weekday.charAt(0).toUpperCase() + weekday.slice(1);
                            }
                        } catch (e) { /* fallthrough */ }
                    }
                    return base.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                }

                function setCounter() {
                    const rawLabel = labels && labels[current] ? labels[current] : `Mapa ${current+1}`;
                    counter.textContent = formatLabel(rawLabel);
                }

                function createImgFor(index) {
                    if (cacheEls[index]) return cacheEls[index];
                    const img = document.createElement('img');
                    img.dataset.index = index;
                    img.alt = formatLabel(labels && labels[index] ? labels[index] : `Mapa ${index+1}`);
                    img.src = urls[index];
                    img.loading = 'lazy';
                    img.addEventListener('load', () => {
                        loadedCount++;
                        if (!overlay.classList.contains('hidden') && (loadedCount >= minToShow || loadedCount === total)) {
                            overlay.classList.add('hidden');
                        }
                        setCounter();
                    });
                    img.addEventListener('error', () => { img.remove(); });
                    cacheEls[index] = img;
                    return img;
                }

                function showSlide(index) {
                    if (index < 0) index = total-1;
                    if (index >= total) index = 0;
                    current = index;
                    const toKeep = [current, (current+1)%total];

                    Array.from(viewport.children).forEach(child => {
                        const idx = Number(child.dataset.index);
                        if (!toKeep.includes(idx)) viewport.removeChild(child);
                    });

                    toKeep.forEach(i => {
                        if (!viewport.querySelector(`img[data-index="${i}"]`)) {
                            const img = createImgFor(i);
                            viewport.appendChild(img);
                        }
                    });

                    Array.from(viewport.querySelectorAll('img')).forEach(img => {
                        img.classList.remove('active');
                        if (Number(img.dataset.index) === current) img.classList.add('active');
                    });
                    setCounter();
                }

                prevBtn.addEventListener('click', () => showSlide(current-1));
                nextBtn.addEventListener('click', () => showSlide(current+1));

                // touch support
                let startX = 0;
                viewport.addEventListener('touchstart', e => startX = e.touches[0].clientX);
                viewport.addEventListener('touchend', e => {
                    const dx = (e.changedTouches[0].clientX - startX);
                    if (Math.abs(dx) > 40) {
                        if (dx < 0) showSlide(current+1);
                        else showSlide(current-1);
                    }
                });

                // initial preload: current and next
                createImgFor(0);
                if (total > 1) createImgFor(1);
                showSlide(0);
            }

            // Always try to fetch fresh data in background to update cache
            fetchFromStorageAndUpdate();
        }

        loadStorageImages();
    </script>
</body>

</html>
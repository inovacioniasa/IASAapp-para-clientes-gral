<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Cargas a Firebase ‚Äî Mercado de Granos</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px;background:#f8f9fa}
    h1{margin-bottom:8px}
    .container{max-width:1100px;margin:0 auto}
    form{max-width:800px;padding:16px;border:1px solid #ddd;border-radius:8px;background:#fff;margin-bottom:20px}
    label{display:block;margin:8px 0 4px;font-weight:600;font-size:0.9em}
    input,textarea,select{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}
    .row{display:flex;gap:12px}
    .row > *{flex:1}
    button{padding:8px 14px;border:none;border-radius:4px;cursor:pointer;font-weight:600}
    .btn-yellow{background:#FBD603;color:#000}
    .btn-grey{background:#e0e0e0;color:#000}
    .btn-red{background:#dc3545;color:#fff;font-size:0.8em;padding:4px 8px}
    .btn-blue{background:#007bff;color:#fff;font-size:0.8em;padding:4px 8px}
    .btn-green{background:#28a745;color:#fff;font-size:0.8em;padding:4px 8px}
    #status{margin-top:12px;white-space:pre-wrap;font-size:0.85em;max-height:120px;overflow-y:auto;background:#f0f0f0;padding:8px;border-radius:4px}
    .small{font-size:0.85em;color:#555}

    /* Tabla estilo mercado */
    .date-banner{background:#FBD603;color:#000;font-weight:800;padding:12px;text-align:center;font-size:1.3rem;margin:20px 0 10px;text-transform:uppercase}
    .table-wrap{overflow-x:auto;margin-bottom:20px}
    .table-mercado{width:100%;border-collapse:collapse;background:#fff;border:1px solid #000}
    .table-mercado th{background:#404041;color:#fff;padding:12px 8px;text-transform:uppercase;font-size:0.8rem;font-weight:800;border:1px solid #000;white-space:nowrap}
    .table-mercado td{padding:8px;text-align:center;font-weight:700;border:1px solid #ddd;white-space:nowrap}
    .table-mercado input{width:90px;padding:4px;text-align:center;font-weight:700;border:1px solid #ccc}
    .table-mercado .input-wide{width:80px}
    .row-grey td{background:#e6e7e8}
    .row-yellow td{background:#FBD603}
    .actions{display:flex;gap:4px;justify-content:center}

    .section-title{font-size:1.1em;font-weight:700;margin:20px 0 10px;border-bottom:2px solid #FBD603;display:inline-block;padding-bottom:4px}
    .auth-bar{margin-bottom:16px;padding:10px;background:#fff;border-radius:6px;display:flex;align-items:center;gap:12px}
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä Cargas a Firebase ‚Äî Mercado de Granos</h1>

    <div class="auth-bar">
      <button id="btn-signin" class="btn-yellow">Iniciar sesi√≥n con Google</button>
      <button id="btn-signout" class="btn-grey" style="display:none">Cerrar sesi√≥n</button>
      <span id="user" class="small"></span>
    </div>

    <!-- SECCI√ìN: Configuraci√≥n del t√≠tulo y fecha -->
    <div class="section-title">‚öôÔ∏è Configuraci√≥n de la p√°gina Mercado</div>
    <div style="background:#fff;padding:16px;border-radius:8px;border:1px solid #ddd;margin-bottom:20px;max-width:800px">
      <div class="row">
        <div style="flex:2">
          <label for="config-titulo">T√≠tulo principal</label>
          <input id="config-titulo" placeholder="APERTURA DE MERCADO" value="APERTURA DE MERCADO">
        </div>
        <div style="flex:1">
          <label for="config-fecha-display">Fecha a mostrar</label>
          <input id="config-fecha-display" type="date">
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:2">
          <button id="btn-save-config" class="btn-yellow" style="width:100%">üíæ Guardar configuraci√≥n</button>
        </div>
        <div style="flex:1">
          <button id="btn-load-config" class="btn-grey" style="width:100%">üîÑ Cargar actual</button>
        </div>
      </div>
      <p id="config-status" class="small" style="margin-top:8px"></p>
    </div>

    <!-- SECCI√ìN: Ver y editar datos existentes -->
    <div class="section-title">üìã Datos actuales en Firebase</div>
    <div class="row" style="align-items:flex-end;margin-bottom:10px">
      <div style="flex:0 0 200px">
        <label for="filter-fecha">Filtrar por fecha:</label>
        <input id="filter-fecha" type="date">
      </div>
      <div>
        <button id="btn-load" class="btn-yellow">üîÑ Cargar datos</button>
      </div>
    </div>

    <div id="preview-banner" class="date-banner" style="display:none"></div>
    <div class="table-wrap">
      <table class="table-mercado" id="tabla-datos">
        <thead>
          <tr>
            <th>Vencimiento</th>
            <th>CRT</th>
            <th>Actual</th>
            <th>Variaci√≥n</th>
            <th>Alto</th>
            <th>Bajo</th>
            <th>Apertura</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody-datos">
          <tr><td colspan="8" style="color:#888;font-weight:400">Seleccion√° una fecha y presion√° "Cargar datos"</td></tr>
        </tbody>
      </table>
    </div>

    <!-- SECCI√ìN: Agregar/Editar registro -->
    <div class="section-title" id="form-title">‚úèÔ∏è Agregar / Editar registro</div>
    <form id="form">
      <input type="hidden" id="edit-id" name="edit-id" value="">
      <label for="fecha">Fecha del reporte</label>
      <input id="fecha" name="fecha" type="date" required>

      <div class="row">
        <div>
          <label for="vencimiento">Vencimiento</label>
          <input id="vencimiento" name="vencimiento" placeholder="MAR 2026" required>
        </div>
        <div>
          <label for="crt">CRT (c√≥digo)</label>
          <input id="crt" name="crt" placeholder="ZSH26" required>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="actual">Actual</label>
          <input id="actual" name="actual" type="text" placeholder="1.144,56">
        </div>
        <div>
          <label for="variacion">Variaci√≥n</label>
          <input id="variacion" name="variacion" type="text" placeholder="+3,50">
        </div>
      </div>

      <div class="row">
        <div>
          <label for="alto">Alto</label>
          <input id="alto" name="alto" type="text" placeholder="1.145,00">
        </div>
        <div>
          <label for="bajo">Bajo</label>
          <input id="bajo" name="bajo" type="text" placeholder="1.137,25">
        </div>
      </div>

      <label for="apertura">Apertura</label>
      <input id="apertura" name="apertura" type="text" placeholder="1.141,00">

      <div class="row" style="margin-top:12px">
        <div style="flex:2">
          <button type="submit" id="btn-submit" class="btn-yellow" style="width:100%">‚úÖ Guardar</button>
        </div>
        <div style="flex:1">
          <button type="button" id="btn-cancel" class="btn-grey" style="width:100%;display:none">‚ùå Cancelar</button>
          <button type="button" id="btn-add-another" class="btn-grey" style="width:100%">+ Nuevo</button>
        </div>
      </div>
      <p id="form-status" class="small" style="margin-top:8px"></p>
    </form>

    <!-- SECCI√ìN: Carga masiva -->
    <div class="section-title">üìÅ Carga masiva desde JSON</div>
    <p class="small">Formato: [{"fecha":"2026-02-20","vencimiento":"MAR 2026","crt":"ZSH26","actual":"1.144,56","variacion":"+55,00","alto":"11.485,00","bajo":"565,00","apertura":"114.100,00"}]</p>
    <div class="row" style="align-items:flex-end">
      <div style="flex:2"><input id="file-json" type="file" accept="application/json"></div>
      <div style="flex:1"><button id="btn-load-json" class="btn-yellow" style="width:100%">Cargar JSON</button></div>
    </div>

    <div id="status"></div>
  </div>

  <script type="module">
    import { db, auth, signInWithGoogle, signOutUser } from '../firebase.js';
    import { addDoc, collection, serverTimestamp, getDocs, query, where, doc, updateDoc, deleteDoc, orderBy, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js';

    const btnSignIn = document.getElementById('btn-signin');
    const btnSignOut = document.getElementById('btn-signout');
    const userEl = document.getElementById('user');
    const status = document.getElementById('status');
    const tbody = document.getElementById('tbody-datos');
    const filterFecha = document.getElementById('filter-fecha');
    const previewBanner = document.getElementById('preview-banner');

    // Setear fecha de hoy por defecto
    const hoy = new Date().toISOString().split('T')[0];
    filterFecha.value = hoy;
    document.getElementById('fecha').value = hoy;
    document.getElementById('config-fecha-display').value = hoy;

    // Referencias de configuraci√≥n
    const configTitulo = document.getElementById('config-titulo');
    const configFechaDisplay = document.getElementById('config-fecha-display');
    const configStatus = document.getElementById('config-status');

    // Cargar configuraci√≥n actual
    async function cargarConfig(){
      try{
        const snap = await getDoc(doc(db, 'config', 'mercado'));
        if(snap.exists()){
          const data = snap.data();
          configTitulo.value = data.titulo || 'APERTURA DE MERCADO';
          configFechaDisplay.value = data.fechaDisplay || hoy;
          configStatus.textContent = '‚úÖ Configuraci√≥n cargada';
        } else {
          configStatus.textContent = 'No hay configuraci√≥n guardada a√∫n';
        }
      }catch(e){
        configStatus.textContent = '‚ùå Error: ' + (e.message||e);
      }
    }

    // Guardar configuraci√≥n
    document.getElementById('btn-save-config').addEventListener('click', async ()=>{
      try{
        await setDoc(doc(db, 'config', 'mercado'), {
          titulo: configTitulo.value || 'APERTURA DE MERCADO',
          fechaDisplay: configFechaDisplay.value || hoy,
          updatedAt: serverTimestamp()
        });
        configStatus.textContent = '‚úÖ Configuraci√≥n guardada!';
        log('‚úÖ Configuraci√≥n de mercado guardada');
      }catch(e){
        configStatus.textContent = '‚ùå Error: ' + (e.message||e);
      }
    });

    document.getElementById('btn-load-config').addEventListener('click', cargarConfig);

    function log(...args){
      status.textContent = args.join(' ') + (status.textContent ? '\n' + status.textContent : '');
    }

    function formatFechaLarga(fechaStr){
      if(!fechaStr) return '';
      const [y,m,d] = fechaStr.split('-');
      const meses = ['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
      return `${parseInt(d)} de ${meses[parseInt(m)]} de ${y}`;
    }

    // Auth
    btnSignIn.addEventListener('click', async ()=>{
      try{ await signInWithGoogle(); }catch(e){ alert('Error: '+(e.message||e)); }
    });
    btnSignOut.addEventListener('click', async ()=>{
      try{ await signOutUser(); }catch(e){ alert('Error: '+(e.message||e)); }
    });
    onAuthStateChanged(auth, user=>{
      if(user){ btnSignIn.style.display='none'; btnSignOut.style.display='inline-block'; userEl.textContent = user.email; }
      else{ btnSignIn.style.display='inline-block'; btnSignOut.style.display='none'; userEl.textContent=''; }
    });

    // Cargar datos de Firebase
    async function cargarDatos(){
      const fecha = filterFecha.value;
      if(!fecha){ alert('Seleccion√° una fecha'); return; }
      tbody.innerHTML = '<tr><td colspan="8">Cargando...</td></tr>';
      previewBanner.textContent = formatFechaLarga(fecha).toUpperCase();
      previewBanner.style.display = 'block';
      try{
        const q = query(collection(db,'mercado'), where('fecha','==',fecha));
        const snap = await getDocs(q);
        if(snap.empty){
          tbody.innerHTML = '<tr><td colspan="8" style="color:#888;font-weight:400">No hay datos para esta fecha</td></tr>';
          return;
        }
        tbody.innerHTML = '';
        let i = 0;
        snap.forEach(docSnap=>{
          const d = docSnap.data();
          const rowClass = i % 2 === 0 ? 'row-grey' : 'row-yellow';
          const tr = document.createElement('tr');
          tr.className = rowClass;
          tr.dataset.id = docSnap.id;
          tr.innerHTML = `
            <td><input class="input-wide" name="vencimiento" value="${d.vencimiento||''}"></td>
            <td><input class="input-wide" name="crt" value="${d.crt||''}"></td>
            <td><input class="input-wide" name="actual" value="${d.actual||''}"></td>
            <td><input class="input-wide" name="variacion" value="${d.variacion||''}"></td>
            <td><input class="input-wide" name="alto" value="${d.alto||''}"></td>
            <td><input class="input-wide" name="bajo" value="${d.bajo||''}"></td>
            <td><input class="input-wide" name="apertura" value="${d.apertura||''}"></td>
            <td class="actions">
              <button class="btn-blue btn-edit" title="Editar en formulario">‚úèÔ∏è</button>
              <button class="btn-green btn-save" title="Guardar cambios">üíæ</button>
              <button class="btn-red btn-delete" title="Eliminar">üóëÔ∏è</button>
            </td>
          `;
          tbody.appendChild(tr);
          i++;
        });
        log('‚úÖ Cargados', snap.size, 'registros para', fecha);
      }catch(e){
        log('‚ùå Error cargando:', e.message||e);
        tbody.innerHTML = '<tr><td colspan="8" style="color:red">Error al cargar</td></tr>';
      }
    }

    document.getElementById('btn-load').addEventListener('click', cargarDatos);

    // Referencias del formulario
    const form = document.getElementById('form');
    const editIdInput = document.getElementById('edit-id');
    const formTitle = document.getElementById('form-title');
    const formStatus = document.getElementById('form-status');
    const btnSubmit = document.getElementById('btn-submit');
    const btnCancel = document.getElementById('btn-cancel');
    const btnAddAnother = document.getElementById('btn-add-another');

    // Funci√≥n para entrar en modo edici√≥n
    function setEditMode(docId, data){
      editIdInput.value = docId;
      form.fecha.value = data.fecha || '';
      form.vencimiento.value = data.vencimiento || '';
      form.crt.value = data.crt || '';
      form.actual.value = data.actual || '';
      form.variacion.value = data.variacion || '';
      form.alto.value = data.alto || '';
      form.bajo.value = data.bajo || '';
      form.apertura.value = data.apertura || '';
      formTitle.textContent = '‚úèÔ∏è Editando: ' + (data.vencimiento || docId);
      btnSubmit.textContent = 'üíæ Actualizar';
      btnCancel.style.display = 'inline-block';
      btnAddAnother.style.display = 'none';
      formStatus.textContent = 'Editando registro existente';
      form.vencimiento.focus();
      form.scrollIntoView({behavior:'smooth', block:'center'});
    }

    // Funci√≥n para salir del modo edici√≥n
    function clearEditMode(){
      editIdInput.value = '';
      const fechaGuardada = filterFecha.value || form.fecha.value;
      form.reset();
      form.fecha.value = fechaGuardada;
      formTitle.textContent = '‚úèÔ∏è Agregar / Editar registro';
      btnSubmit.textContent = '‚úÖ Guardar';
      btnCancel.style.display = 'none';
      btnAddAnother.style.display = 'inline-block';
      formStatus.textContent = '';
    }

    // Guardar cambios en una fila o editar en formulario
    tbody.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('button');
      if(!btn) return;
      const tr = btn.closest('tr');
      const docId = tr.dataset.id;
      if(!docId) return;

      if(btn.classList.contains('btn-edit')){
        // Cargar datos en el formulario
        const inputs = tr.querySelectorAll('input');
        const data = { fecha: filterFecha.value };
        inputs.forEach(inp=>{ data[inp.name] = inp.value; });
        setEditMode(docId, data);
      }

      if(btn.classList.contains('btn-save')){
        const inputs = tr.querySelectorAll('input');
        const data = {};
        inputs.forEach(inp=>{ data[inp.name] = inp.value; });
        try{
          await updateDoc(doc(db,'mercado',docId), data);
          log('‚úÖ Actualizado:', docId, data.vencimiento);
          btn.textContent = '‚úì';
          setTimeout(()=>{ btn.textContent = 'üíæ'; }, 1500);
        }catch(e){
          log('‚ùå Error al guardar:', e.message||e);
        }
      }

      if(btn.classList.contains('btn-delete')){
        if(!confirm('¬øEliminar este registro?')) return;
        try{
          await deleteDoc(doc(db,'mercado',docId));
          tr.remove();
          log('üóëÔ∏è Eliminado:', docId);
          // Si estaba editando este, limpiar formulario
          if(editIdInput.value === docId) clearEditMode();
        }catch(e){
          log('‚ùå Error al eliminar:', e.message||e);
        }
      }
    });

    // Bot√≥n cancelar edici√≥n
    btnCancel.addEventListener('click', clearEditMode);

    // Bot√≥n nuevo (limpiar formulario)
    btnAddAnother.addEventListener('click', clearEditMode);

    // Guardar o actualizar documento
    // Guardar o actualizar documento
    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const docId = editIdInput.value;
      const data = {
        fecha: form.fecha.value || '',
        vencimiento: form.vencimiento.value || '',
        crt: form.crt.value || '',
        actual: form.actual.value || '',
        variacion: form.variacion.value || '',
        alto: form.alto.value || '',
        bajo: form.bajo.value || '',
        apertura: form.apertura.value || ''
      };
      
      try{
        if(docId){
          // Actualizar documento existente
          await updateDoc(doc(db,'mercado',docId), data);
          log('‚úÖ Actualizado:', docId, data.vencimiento, data.crt);
          formStatus.textContent = '‚úÖ Actualizado correctamente';
          clearEditMode();
        } else {
          // Crear nuevo documento
          data.createdAt = serverTimestamp();
          const ref = await addDoc(collection(db,'mercado'), data);
          log('‚úÖ Agregado:', ref.id, data.vencimiento, data.crt);
          formStatus.textContent = '‚úÖ Agregado correctamente';
          clearEditMode();
        }
        // Recargar tabla si la fecha coincide
        if(filterFecha.value === data.fecha) cargarDatos();
      }catch(e){
        log('‚ùå Error:', e.message || e);
        formStatus.textContent = '‚ùå Error: ' + (e.message || e);
      }
    });

    // Carga masiva desde JSON
    document.getElementById('btn-load-json').addEventListener('click', async ()=>{
      const input = document.getElementById('file-json');
      if(!input.files || !input.files[0]){ alert('Seleccion√° un archivo JSON'); return; }
      const file = input.files[0];
      try{
        const text = await file.text();
        const parsed = JSON.parse(text);
        const items = Array.isArray(parsed)? parsed : (parsed.items||[]);
        if(!Array.isArray(items)) throw new Error('JSON no contiene un array');
        log('Iniciando carga masiva:', items.length, 'items');
        let i=0;
        for(const it of items){
          const docData = {
            fecha: it.fecha || it.date || '',
            vencimiento: it.vencimiento || it.venc || it.periodo || '',
            crt: it.crt || it.code || it.codigo || '',
            actual: it.actual != null? String(it.actual) : '',
            variacion: it.variacion || it.variation || it.var || '',
            alto: it.alto != null? String(it.alto) : '',
            bajo: it.bajo != null? String(it.bajo) : '',
            apertura: it.apertura != null? String(it.apertura) : '',
            createdAt: serverTimestamp()
          };
          try{ await addDoc(collection(db,'mercado'), docData); i++; }
          catch(e){ log('‚ùå', docData.vencimiento, e.message||e); }
        }
        log('‚úÖ Carga completa:', i, '/', items.length);
        cargarDatos();
      }catch(e){ log('‚ùå Error JSON:', e.message||e); }
    });

    // Cargar datos y configuraci√≥n autom√°ticamente al inicio
    cargarDatos();
    cargarConfig();
  </script>
</body>
</html>

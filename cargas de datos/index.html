<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Cargar reporte - Firestore</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:18px;background:#f7f7f7}
    form{background:#fff;padding:16px;border-radius:6px;max-width:720px;margin:0 auto;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    label{display:block;margin-top:10px;font-weight:600}
    input[type=text], textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    button{margin-top:12px;padding:10px 14px;border:0;background:#2b7cff;color:#fff;border-radius:4px;cursor:pointer}
    .status{margin-top:10px;color:#333}
  </style>
</head>
<body>
  <h2>Cargar / Actualizar reporte en Firestore</h2>
  <p>Los datos se guardan siempre en un documento fijo dentro de la colección seleccionada. Al guardar se sobrescribe el anterior.</p>

  <div style="max-width:720px;margin:0 auto 12px;display:flex;gap:12px;align-items:center">
    <label for="collectionSelect" style="margin:0;font-weight:600">Colección:</label>
    <select id="collectionSelect">
      <option value="reportes_A">Reportes A (ej: MAR/MAY)</option>
      <option value="reportes_B">Reportes B (ej: JUL)</option>
      <option value="reportes_C">Reportes C (otros)</option>
    </select>
    <div id="editingBadge" style="margin-left:auto;padding:6px 10px;border-radius:6px;background:#eee;font-weight:700">Editando: reportes_A</div>
  </div>

  <div id="preview" style="max-width:960px;margin:0 auto 18px;padding:12px;border-radius:6px;background:linear-gradient(90deg,#fff,#fcfcff);box-shadow:0 2px 6px rgba(0,0,0,.06);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Vista previa del documento</strong>
      <small id="previewCollection" style="opacity:.8">reportes_A / latestReport</small>
    </div>
    <div id="previewBody" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;font-size:14px;color:#222">
      <div><strong>Título</strong><div id="pv_titulo">—</div></div>
      <div><strong>Subtítulo</strong><div id="pv_subtitulo">—</div></div>
      <div><strong>Fecha</strong><div id="pv_fecha">—</div></div>
      <div><strong>Vencimiento</strong><div id="pv_vencimiento">—</div></div>
      <div><strong>CRT</strong><div id="pv_crt">—</div></div>
      <div><strong>Actual</strong><div id="pv_actual">—</div></div>
      <div><strong>Variación</strong><div id="pv_variacion">—</div></div>
      <div><strong>Alto</strong><div id="pv_alto">—</div></div>
      <div><strong>Bajo</strong><div id="pv_bajo">—</div></div>
      <div><strong>Apertura</strong><div id="pv_apertura">—</div></div>
      <div style="grid-column:1/-1"><strong>Notas</strong><div id="pv_notas">—</div></div>
    </div>
  </div>

  <form id="reportForm">
    <label for="titulo">Título</label>
    <input id="titulo" name="titulo" type="text" placeholder="Título del reporte" required>

    <label for="subtitulo">Subtítulo</label>
    <input id="subtitulo" name="subtitulo" type="text" placeholder="Subtítulo del reporte">

    <div class="row">
      <div>
        <label for="fecha">Fecha</label>
        <input id="fecha" name="fecha" type="text" placeholder="23/02/2026">
      </div>
      <div>
        <label for="vencimiento">Vencimiento</label>
        <input id="vencimiento" name="vencimiento" type="text" placeholder="MAR 2026">
      </div>
    </div>

    <div class="row">
      <div>
        <label for="crt">CRT (código)</label>
        <input id="crt" name="crt" type="text" placeholder="ZSH26">
      </div>
      <div>
        <label for="actual">Actual</label>
        <input id="actual" name="actual" type="text" placeholder="1.144,56">
      </div>
    </div>

    <div class="row">
      <div>
        <label for="variacion">Variación</label>
        <input id="variacion" name="variacion" type="text" placeholder="+3,50">
      </div>
      <div>
        <label for="alto">Alto</label>
        <input id="alto" name="alto" type="text" placeholder="1.145,00">
      </div>
    </div>

    <div class="row">
      <div>
        <label for="bajo">Bajo</label>
        <input id="bajo" name="bajo" type="text" placeholder="1.137,25">
      </div>
      <div>
        <label for="apertura">Apertura</label>
        <input id="apertura" name="apertura" type="text" placeholder="1.141,00">
      </div>
    </div>

    <label for="notas">Notas / contenido adicional</label>
    <textarea id="notas" name="notas" rows="4" placeholder="Texto adicional..."></textarea>

    <button type="submit">Guardar (sobrescribir)</button>
    <div class="status" id="status"></div>
  </form>

  <script type="module">
    import { db } from '../firebase.js';
    import { doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js';

    const form = document.getElementById('reportForm');
    const statusEl = document.getElementById('status');
    const selectEl = document.getElementById('collectionSelect');
    const badgeEl = document.getElementById('editingBadge');

    // Configuración: colecciones disponibles y id fijo del documento dentro de cada colección
    const COLLECTIONS = ['reportes_A','reportes_B','reportes_C'];
    const DOC_ID = 'latestReport';

    // Colores para el badge (opcional)
    const BADGE_COLORS = {
      'reportes_A': '#ffd54f',
      'reportes_B': '#90caf9',
      'reportes_C': '#c8e6c9'
    };

    function showStatus(msg, isError=false){
      statusEl.textContent = msg;
      statusEl.style.color = isError ? 'crimson' : '#333';
    }

    function currentCollection(){
      return selectEl.value;
    }

    function updateBadge(){
      const c = currentCollection();
      badgeEl.textContent = 'Editando: ' + c;
      badgeEl.style.background = BADGE_COLORS[c] || '#eee';
    }

    async function loadExisting(){
      showStatus('Cargando datos...');
      try{
        const COLLECTION = currentCollection();
        const ref = doc(db, COLLECTION, DOC_ID);
        const snap = await getDoc(ref);
        if(snap.exists()){
          const data = snap.data();
          // Rellenar campos si existen
          for(const key of ['titulo','subtitulo','fecha','vencimiento','crt','actual','variacion','alto','bajo','apertura','notas']){
            if(data[key] !== undefined && document.getElementById(key)) document.getElementById(key).value = data[key];
          }
          updatePreview(data);
          showStatus('Datos cargados de ' + COLLECTION + '. Edita y guarda para sobrescribir.');
        } else {
          // limpiar campos si no existe
          for(const key of ['titulo','subtitulo','fecha','vencimiento','crt','actual','variacion','alto','bajo','apertura','notas']){
            if(document.getElementById(key)) document.getElementById(key).value = '';
          }
          updatePreview({});
          showStatus('No hay documento previo en ' + COLLECTION + '. Rellena el formulario y guarda.');
        }
      }catch(err){
        console.error(err);
        showStatus('Error al cargar datos: '+err.message, true);
      }
    }

    // --- Vista previa en tiempo real ---
    const pvFields = ['titulo','subtitulo','fecha','vencimiento','crt','actual','variacion','alto','bajo','apertura','notas'];
    function updatePreview(data){
      // actualizar badge/colección
      const col = currentCollection();
      const previewCollection = document.getElementById('previewCollection');
      if(previewCollection) previewCollection.textContent = col + ' / ' + DOC_ID;

      for(const f of pvFields){
        const pv = document.getElementById('pv_' + f);
        if(pv) pv.textContent = (data && data[f]) ? data[f] : '—';
      }
    }

    // Live preview while el usuario escribe: leer valores del formulario
    function updatePreviewFromForm(){
      const obj = {};
      for(const f of pvFields){
        const el = document.getElementById(f);
        obj[f] = el ? el.value : '';
      }
      updatePreview(obj);
    }

    // añadir listeners para actualizar preview en cada input
    for(const f of pvFields){
      const el = document.getElementById(f);
      if(el) el.addEventListener('input', updatePreviewFromForm);
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      showStatus('Guardando...');
      const payload = {};
      const fields = ['titulo','subtitulo','fecha','vencimiento','crt','actual','variacion','alto','bajo','apertura','notas'];
      for(const f of fields){
        const el = document.getElementById(f);
        payload[f] = el ? el.value : '';
      }
      payload.updatedAt = new Date().toISOString();

      try{
          const ref = doc(db, currentCollection(), DOC_ID);
          await setDoc(ref, payload);
          showStatus('Guardado correctamente en ' + currentCollection() + '. El documento fue sobrescrito.');
      }catch(err){
        console.error(err);
        showStatus('Error al guardar: '+err.message, true);
      }
    });

    // Persistir selección y cargar al inicio
    function saveSelection(){ localStorage.setItem('report_collection', selectEl.value); }
    function loadSelection(){
      const v = localStorage.getItem('report_collection');
      if(v && COLLECTIONS.includes(v)) selectEl.value = v;
    }

    selectEl.addEventListener('change', ()=>{ saveSelection(); updateBadge(); loadExisting(); });

    // inicializar
    window.addEventListener('DOMContentLoaded', ()=>{
      loadSelection();
      updateBadge();
      loadExisting();
    });
  </script>

  <!-- Nota: este archivo usa módulos ES y debe servirse desde un servidor local o remoto -->
</body>
</html>

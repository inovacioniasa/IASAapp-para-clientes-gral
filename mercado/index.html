<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IASA - Apertura de Mercado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap');
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f8f9fa;
        }

        .market-header {
            border-bottom: 3px solid #FBD603;
            display: inline-block;
            padding-bottom: 5px;
            margin-bottom: 20px;
        }
        .table-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 12px;
        }
        .logo-img{max-width:220px;height:auto;object-fit:contain}

        .date-banner {
            background-color: #FBD603;
            color: #000;
            font-weight: 800;
            padding: 10px;
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 40px;
        }

        .table-custom {
            width: 100%;
            border-collapse: collapse;
            background: transparent;
            border: 1px solid #000;
        }

        .table-custom th {
            background-color: #404041;
            color: white;
            padding: 14px 12px;
            text-transform: uppercase;
            font-size: 0.9rem;
            border: 1px solid #000;
            font-weight: 800;
            letter-spacing: 0.6px;
            white-space: nowrap;
        }



        .table-custom td {
            padding: 12px;
            text-align: center;
            font-weight: 700;
            vertical-align: middle;
            background: #fff;
            border: 1px solid #ffffff;
            white-space: nowrap;
        }

        .row-grey {
            background-color: #e6e7e8;
        }

        .row-grey td{ background: #e6e7e8; color:#000; font-weight:800; }

        .row-yellow {
            background-color: #FBD603;
        }

        .row-yellow td{ background: #FBD603; color:#000; font-weight:800; }



        .variation-positive {
            color: #1a8a44;
        }

        .hours-container {
            border: 2px solid #FBD603;
            max-width: 400px;
            margin: 40px auto;
        }

        /* Logos marquee */
        .logo-marquee { overflow: hidden; margin: 18px 0 18px; }
        .marquee-track { display:flex; gap:24px; align-items:center; width:max-content; }
        .marquee-wrap { display:flex; animation: scroll-right 16s linear infinite; }
        .marquee-item img{height:52px;display:block;filter:grayscale(0);opacity:0.95}
        .marquee-track:hover .marquee-wrap{ animation-play-state: paused; }

        @keyframes scroll-right {
            0% { transform: translateX(-50%); }
            100% { transform: translateX(0%); }
        }

        .hours-header {
            border-bottom: 2px solid #FBD603;
            padding: 5px;
            font-weight: 800;
            font-size: 0.75rem;
            text-align: center;
        }

        .hours-row {
            display: flex;
            border-bottom: 1px solid #FBD603;
        }

        .hours-row:last-child {
            border-bottom: none;
        }

        .hours-label {
            flex: 1;
            background-color: #fff;
            padding: 10px;
            font-weight: 800;
            font-size: 0.8rem;
            border-right: 1px solid #fec001;
            text-align: center;
        }

        .hours-value {
            flex: 2;
            padding: 10px;
            font-size: 0.8rem;
            text-align: center;
        }
        
        /*  Responsive  */
        @media (max-width: 768px) {
            body { padding: 8px !important; }
            .max-w-4xl { padding: 12px !important; }
            .logo-img { max-width: 140px; }
            .market-header { font-size: 1.1rem !important; }
            .date-banner { font-size: 1rem; padding: 8px; margin-bottom: 20px; }
            .table-custom th { padding: 6px 4px; font-size: 0.65rem; }
            .table-custom td { padding: 6px 4px; font-size: 0.7rem; }
            .hours-container { max-width: 100%; margin: 20px auto; }
            .hours-label, .hours-value { font-size: 0.7rem; padding: 6px; }
            .hours-header { font-size: 0.65rem; }
            .marquee-item img{height:100px}
        }

        @media (max-width: 420px) {
            .logo-img { max-width: 110px; margin-top: 10px; }
            .market-header { font-size: 0.95rem !important; margin-bottom: 10px; }
            .date-banner { font-size: 0.85rem; padding: 6px; margin-bottom: 14px; }
            /* Encoger tabla en m贸viles: menos padding y letra m谩s chica, siempre en una l铆nea */
            .table-custom th { padding: 3px 2px; font-size: 0.48rem; white-space: nowrap !important; letter-spacing: 0; }
            .table-custom td { padding: 3px 2px; font-size: 0.52rem; white-space: nowrap !important; }
            .table-custom { table-layout: auto; }
            .hours-container { margin: 14px auto; }
            .hours-label, .hours-value { font-size: 0.62rem; padding: 5px; }
            .row-grey, .row-yellow { background-clip: padding-box; }
            .marquee-item img{height:36px}
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 shadow-sm min-h-screen">
        
        <!-- Header Section -->
        <div class="text-center mb-8">
            <!-- Espacio para el logo -->
            <div class="h-20 flex items-center justify-center mb-4">
                <img src="../iconos/logoiasanegro.png" alt="IASA" class="logo-img" />
            </div>
            <h1 class="market-header text-2xl md:text-3xl font-extrabold tracking-tighter" id="market-title">
                APERTURA DE MERCADO
            </h1>
        </div>

        <!-- Date Banner -->
        <div class="date-banner uppercase" id="date-banner">
            Cargando...
        </div>

        <!-- Main Data Tables -->
        <div class="table-wrap">
            <table class="table-custom mb-8">
                <thead>
                    <tr>
                        <th>Vencimiento</th>
                        <th>CRT</th>
                        <th>Actual</th>
                        <th>Variaci贸n</th>
                        <th>Alto</th>
                        <th>Bajo</th>
                        <th>Apertura</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="7" style="text-align:center;color:#888;padding:20px">Cargando datos...</td></tr>
                </tbody>
            </table>
        </div>
        <!-- Trading Hours Section -->
        <div class="hours-container">
            <div class="hours-header">HORRIOS DEL MERCADO</div>
            <div class="hours-row">
                <div class="hours-label">DIURNO</div>
                <div class="hours-value">11:30 hs. hasta 16:20 hs.</div>
            </div>
            <div class="hours-row">
                <div class="hours-label">NOCTURNO</div>
                <div class="hours-value">22:00 hs. hasta 10:45 hs.</div>
            </div>
        </div>

        <!-- Logos marquee -->
        <div class="logo-marquee" aria-hidden="true">
            <div class="marquee-track">
                <div class="marquee-wrap">
                    <div class="marquee-item"><img src="../indexlogos/CULTIVE-NEGRO.png" alt="Cultive"></div>
                    <div class="marquee-item"><img src="../indexlogos/FORSEED-NEGRO.png" alt="Forseed"></div>
                    <div class="marquee-item"><img src="../indexlogos/MICROPHOS.png" alt="Microphos"></div>
                    <div class="marquee-item"><img src="../indexlogos/SOBERANA-NEGRO.png" alt="Soberana"></div>
                    <div class="marquee-item"><img src="../indexlogos/TOTAL-S-NEGRO.png" alt="Total"></div>
                    <div class="marquee-item"><img src="../indexlogos/VALORE-NEGRO.png" alt="Valore"></div>
                    <!-- duplicate for seamless scroll -->
                    <div class="marquee-item"><img src="../indexlogos/CULTIVE-NEGRO.png" alt="Cultive"></div>
                    <div class="marquee-item"><img src="../indexlogos/FORSEED-NEGRO.png" alt="Forseed"></div>
                    <div class="marquee-item"><img src="../indexlogos/MICROPHOS.png" alt="Microphos"></div>
                    <div class="marquee-item"><img src="../indexlogos/SOBERANA-NEGRO.png" alt="Soberana"></div>
                    <div class="marquee-item"><img src="../indexlogos/TOTAL-S-NEGRO.png" alt="Total"></div>
                    <div class="marquee-item"><img src="../indexlogos/VALORE-NEGRO.png" alt="Valore"></div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
    import { db } from '../firebase.js';
    import { collection, getDocs, doc, getDoc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js';

    console.log(' Mercado: Script iniciado');
    console.log(' DB object:', db);

    function fmt(v){
        if(v == null) return '';
        if(typeof v === 'number') return v.toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2});
        // try parse number-like strings
        const n = Number(String(v).replace(/\./g,'').replace(',','.'));
        if(!isNaN(n)) return n.toLocaleString('es-AR',{minimumFractionDigits:2, maximumFractionDigits:2});
        return String(v);
    }

    function formatFechaLarga(fechaStr){
      if(!fechaStr) return '';
      const [y,m,d] = fechaStr.split('-');
      const meses = ['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
      return `${parseInt(d)} de ${meses[parseInt(m)]} de ${y}`;
    }

    // Cargar configuraci贸n (t铆tulo y fecha)
    async function loadConfig(){
      console.log(' loadConfig: Iniciando...');
      try{
        const snap = await getDoc(doc(db, 'config', 'mercado'));
        console.log(' loadConfig: snap.exists()=', snap.exists());
        if(snap.exists()){
          const data = snap.data();
          console.log(' loadConfig: data=', data);
          // T铆tulo
          const titleEl = document.getElementById('market-title');
          if(titleEl && data.titulo) titleEl.textContent = data.titulo;
          // Fecha
          const bannerEl = document.getElementById('date-banner');
          if(bannerEl && data.fechaDisplay){
            bannerEl.textContent = formatFechaLarga(data.fechaDisplay).toUpperCase();
          }
          // Retornar fecha para filtrar datos
          return data.fechaDisplay || null;
        } else {
          console.log(' loadConfig: Documento config/mercado NO existe');
        }
      }catch(e){
        console.error(' loadConfig ERROR:', e);
      }
      return null;
    }

    async function loadMarket(){
        console.log(' loadMarket: Iniciando...');
        // Primero cargar configuraci贸n
        const fechaConfig = await loadConfig();
        console.log(' loadMarket: fechaConfig=', fechaConfig);
        try{
            // Intentar leer `latestReport` desde las tres colecciones principales
            const cols = ['reportes','reportes_B','reportes_C'];
            const tbody = document.querySelector('table.table-custom tbody');
            if(!tbody) return;
            tbody.innerHTML = '';

            let foundAny = false;
            for(const col of cols){
                try{
                    const snap = await getDoc(doc(db, col, 'latestReport'));
                    if(snap.exists()){
                        foundAny = true;
                        const d = snap.data();
                        console.log(` loadMarket: latestReport en ${col} =`, d);

                        // Si es la primera colecci贸n encontrada, actualizar t铆tulo/banner con sus datos (si hay)
                        const titleEl = document.getElementById('market-title');
                        const bannerEl = document.getElementById('date-banner');
                        if(!document.body.dataset._marketHeaderSet){
                            if(titleEl && d.titulo) titleEl.textContent = d.titulo;
                            if(bannerEl){
                                if(d.subtitulo) bannerEl.textContent = String(d.subtitulo).toUpperCase();
                                else if(d.fecha) bannerEl.textContent = String(d.fecha).toUpperCase();
                            }
                            document.body.dataset._marketHeaderSet = '1';
                        }

                        // (No mostrar nombre de la colecci贸n: s贸lo a帽adir la fila de datos)

                        const varNum = Number(String(d.variacion || '0').replace(/[+]/g,'').replace(/\./g,'').replace(',','.'));
                        const varClass = varNum >= 0 ? 'variation-positive' : '';

                        const tr = document.createElement('tr');
                        tr.className = 'row-grey';
                        tr.innerHTML = `
                            <td data-label="Vencimiento">${d.vencimiento || ''}</td>
                            <td data-label="CRT">${d.crt || ''}</td>
                            <td data-label="Actual">${fmt(d.actual) || ''}</td>
                            <td data-label="Variaci贸n" class="${varClass}">${d.variacion || ''}</td>
                            <td data-label="Alto">${fmt(d.alto) || ''}</td>
                            <td data-label="Bajo">${fmt(d.bajo) || ''}</td>
                            <td data-label="Apertura">${fmt(d.apertura) || ''}</td>
                        `;
                        tbody.appendChild(tr);
                    }
                }catch(e){
                    console.warn(' loadMarket: error leyendo', col, e);
                }
            }

            if(foundAny) return; // ya mostramos los latestReport disponibles

            // Si no existe latestReport, caer al comportamiento anterior: colecci贸n 'mercado'
            let snap;
            if(fechaConfig){
              console.log(' loadMarket: Buscando en colecci贸n "mercado" con fecha=', fechaConfig);
              const q = query(collection(db, 'mercado'), where('fecha','==',fechaConfig));
              snap = await getDocs(q);
            } else {
              console.log(' loadMarket: Cargando TODOS los datos de colecci贸n "mercado" (sin filtro de fecha)');
              snap = await getDocs(collection(db, 'mercado'));
            }

            console.log(' loadMarket: Documentos encontrados=', snap.size);

            // Limpiar filas existentes (ya est谩n limpias pero por seguridad)
            tbody.innerHTML = '';

            let i = 0;
            snap.forEach(s => {
                const d = s.data();
                console.log(' loadMarket: Doc', i, '=', d);
                const rowClass = i % 2 === 0 ? 'row-grey' : 'row-yellow';
                const varNum = Number(String(d.variacion || '0').replace(/[+]/g,'').replace(/\./g,'').replace(',','.'));
                const varClass = varNum >= 0 ? 'variation-positive' : '';

                const tr = document.createElement('tr');
                tr.className = rowClass;
                tr.innerHTML = `
                    <td data-label="Vencimiento">${d.vencimiento || ''}</td>
                    <td data-label="CRT">${d.crt || ''}</td>
                    <td data-label="Actual">${fmt(d.actual) || ''}</td>
                    <td data-label="Variaci贸n" class="${varClass}">${d.variacion || ''}</td>
                    <td data-label="Alto">${fmt(d.alto) || ''}</td>
                    <td data-label="Bajo">${fmt(d.bajo) || ''}</td>
                    <td data-label="Apertura">${fmt(d.apertura) || ''}</td>
                `;
                tbody.appendChild(tr);
                i++;
            });

            if(i === 0){
                console.log(' loadMarket: No hay datos para mostrar');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#888">No hay datos disponibles</td></tr>';
            }

        }catch(err){
            console.error(' loadMarket ERROR:', err);
        }
    }

    loadMarket();
    </script>

</body>
</html>